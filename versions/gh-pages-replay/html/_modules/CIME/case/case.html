<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CIME.case.case &mdash; CIME with documentation about the Replay cime5.6.replay documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../_static/documentation_options.js?v=5d88beb4"></script>
        <script src="../../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="../../../_static/pop_ver.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            CIME with documentation about the Replay
          </a>
              <div class="version">
                cime5.6.replay
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../what_cime/index.html">What is CIME?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../users_guide/index.html">Case Control System Part 1: Basic Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../users_guide/index.html#case-control-system-part-2-configuration-porting-testing-and-use-cases">Case Control System Part 2: Configuration, Porting, Testing and Use Cases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../data_models/index.html">Data Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../driver_cpl/index.html">Driver/Coupler</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../build_cpl/index.html">Building a Coupled Model with CIME</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../misc_tools/index.html">Miscellaneous Tools</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../glossary/index.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Tools_user/index.html">User Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../xml_files/index.html">XML Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../CIME_api/modules.html">CIME</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Tools_api/modules.html">Tools</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">CIME with documentation about the Replay</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">CIME.case.case</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for CIME.case.case</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Wrapper around all env XML for a case.</span>

<span class="sd">All interaction with and between the module files in XML/ takes place</span>
<span class="sd">through the Case module.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">import</span> <span class="nn">glob</span><span class="o">,</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">shutil</span><span class="o">,</span> <span class="nn">math</span><span class="o">,</span> <span class="nn">six</span>
<span class="kn">from</span> <span class="nn">CIME.XML.standard_module_setup</span> <span class="kn">import</span> <span class="o">*</span>
<span class="c1">#pylint: disable=import-error,redefined-builtin</span>
<span class="kn">from</span> <span class="nn">six.moves</span> <span class="kn">import</span> <span class="nb">input</span>
<span class="kn">from</span> <span class="nn">CIME.utils</span>                     <span class="kn">import</span> <span class="n">expect</span><span class="p">,</span> <span class="n">get_cime_root</span><span class="p">,</span> <span class="n">append_status</span>
<span class="kn">from</span> <span class="nn">CIME.utils</span>                     <span class="kn">import</span> <span class="n">convert_to_type</span><span class="p">,</span> <span class="n">get_model</span>
<span class="kn">from</span> <span class="nn">CIME.utils</span>                     <span class="kn">import</span> <span class="n">get_project</span><span class="p">,</span> <span class="n">get_charge_account</span><span class="p">,</span> <span class="n">check_name</span>
<span class="kn">from</span> <span class="nn">CIME.utils</span>                     <span class="kn">import</span> <span class="n">get_current_commit</span><span class="p">,</span> <span class="n">safe_copy</span>
<span class="kn">from</span> <span class="nn">CIME.locked_files</span>              <span class="kn">import</span> <span class="n">LOCKED_DIR</span><span class="p">,</span> <span class="n">lock_file</span>
<span class="kn">from</span> <span class="nn">CIME.XML.machines</span>              <span class="kn">import</span> <span class="n">Machines</span>
<span class="kn">from</span> <span class="nn">CIME.XML.pes</span>                   <span class="kn">import</span> <span class="n">Pes</span>
<span class="kn">from</span> <span class="nn">CIME.XML.files</span>                 <span class="kn">import</span> <span class="n">Files</span>
<span class="kn">from</span> <span class="nn">CIME.XML.testlist</span>              <span class="kn">import</span> <span class="n">Testlist</span>
<span class="kn">from</span> <span class="nn">CIME.XML.component</span>             <span class="kn">import</span> <span class="n">Component</span>
<span class="kn">from</span> <span class="nn">CIME.XML.compsets</span>              <span class="kn">import</span> <span class="n">Compsets</span>
<span class="kn">from</span> <span class="nn">CIME.XML.grids</span>                 <span class="kn">import</span> <span class="n">Grids</span>
<span class="kn">from</span> <span class="nn">CIME.XML.batch</span>                 <span class="kn">import</span> <span class="n">Batch</span>
<span class="kn">from</span> <span class="nn">CIME.XML.workflow</span>              <span class="kn">import</span> <span class="n">Workflow</span>
<span class="kn">from</span> <span class="nn">CIME.XML.pio</span>                   <span class="kn">import</span> <span class="n">PIO</span>
<span class="kn">from</span> <span class="nn">CIME.XML.archive</span>               <span class="kn">import</span> <span class="n">Archive</span>
<span class="kn">from</span> <span class="nn">CIME.XML.env_test</span>              <span class="kn">import</span> <span class="n">EnvTest</span>
<span class="kn">from</span> <span class="nn">CIME.XML.env_mach_specific</span>     <span class="kn">import</span> <span class="n">EnvMachSpecific</span>
<span class="kn">from</span> <span class="nn">CIME.XML.env_case</span>              <span class="kn">import</span> <span class="n">EnvCase</span>
<span class="kn">from</span> <span class="nn">CIME.XML.env_mach_pes</span>          <span class="kn">import</span> <span class="n">EnvMachPes</span>
<span class="kn">from</span> <span class="nn">CIME.XML.env_build</span>             <span class="kn">import</span> <span class="n">EnvBuild</span>
<span class="kn">from</span> <span class="nn">CIME.XML.env_run</span>               <span class="kn">import</span> <span class="n">EnvRun</span>
<span class="kn">from</span> <span class="nn">CIME.XML.env_archive</span>           <span class="kn">import</span> <span class="n">EnvArchive</span>
<span class="kn">from</span> <span class="nn">CIME.XML.env_batch</span>             <span class="kn">import</span> <span class="n">EnvBatch</span>
<span class="kn">from</span> <span class="nn">CIME.XML.env_workflow</span>          <span class="kn">import</span> <span class="n">EnvWorkflow</span>
<span class="kn">from</span> <span class="nn">CIME.XML.generic_xml</span>           <span class="kn">import</span> <span class="n">GenericXML</span>
<span class="kn">from</span> <span class="nn">CIME.user_mod_support</span>          <span class="kn">import</span> <span class="n">apply_user_mods</span>
<span class="kn">from</span> <span class="nn">CIME.aprun</span> <span class="kn">import</span> <span class="n">get_aprun_cmd_for_case</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<div class="viewcode-block" id="Case">
<a class="viewcode-back" href="../../../CIME_api/CIME.case.html#CIME.case.case.Case">[docs]</a>
<span class="k">class</span> <span class="nc">Case</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    https://github.com/ESMCI/cime/wiki/Developers-Introduction</span>
<span class="sd">    The Case class is the heart of the CIME Case Control system.  All</span>
<span class="sd">    interactions with a Case take part through this class.  All of the</span>
<span class="sd">    variables used to create and manipulate a case are defined in xml</span>
<span class="sd">    files and for every xml file there is a python class to interact</span>
<span class="sd">    with that file.</span>

<span class="sd">    XML files which are part of the CIME distribution and are meant to</span>
<span class="sd">    be readonly with respect to a case are typically named</span>
<span class="sd">    config_something.xml and the corresponding python Class is</span>
<span class="sd">    Something and can be found in file CIME.XML.something.py.  I&#39;ll</span>
<span class="sd">    refer to these as the CIME config classes.</span>

<span class="sd">    XML files which are part of a case and thus are read/write to a</span>
<span class="sd">    case are typically named env_whatever.xml and the cooresponding</span>
<span class="sd">    python modules are CIME.XML.env_whatever.py and classes are</span>
<span class="sd">    EnvWhatever.  I&#39;ll refer to these as the Case env classes.</span>

<span class="sd">    The Case Class includes an array of the Case env classes, in the</span>
<span class="sd">    configure function and it&#39;s supporting functions defined below</span>
<span class="sd">    the case object creates and manipulates the Case env classes</span>
<span class="sd">    by reading and interpreting the CIME config classes.</span>

<span class="sd">    This class extends across multiple files, class members external to this file</span>
<span class="sd">    are listed in the following imports</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">CIME.case.case_setup</span> <span class="kn">import</span> <span class="n">case_setup</span>
    <span class="kn">from</span> <span class="nn">CIME.case.case_clone</span> <span class="kn">import</span> <span class="n">create_clone</span><span class="p">,</span> <span class="n">_copy_user_modified_to_clone</span>
    <span class="kn">from</span> <span class="nn">CIME.case.case_test</span>  <span class="kn">import</span> <span class="n">case_test</span>
    <span class="kn">from</span> <span class="nn">CIME.case.case_submit</span> <span class="kn">import</span> <span class="n">check_DA_settings</span><span class="p">,</span> <span class="n">check_case</span><span class="p">,</span> <span class="n">submit</span>
    <span class="kn">from</span> <span class="nn">CIME.case.case_st_archive</span> <span class="kn">import</span> <span class="n">case_st_archive</span><span class="p">,</span> <span class="n">restore_from_archive</span><span class="p">,</span> \
        <span class="n">archive_last_restarts</span><span class="p">,</span> <span class="n">test_st_archive</span><span class="p">,</span> <span class="n">test_env_archive</span>
    <span class="kn">from</span> <span class="nn">CIME.case.case_run</span> <span class="kn">import</span> <span class="n">case_run</span>
    <span class="kn">from</span> <span class="nn">CIME.case.case_cmpgen_namelists</span> <span class="kn">import</span> <span class="n">case_cmpgen_namelists</span>
    <span class="kn">from</span> <span class="nn">CIME.case.check_lockedfiles</span> <span class="kn">import</span> <span class="n">check_lockedfile</span><span class="p">,</span> <span class="n">check_lockedfiles</span><span class="p">,</span> <span class="n">check_pelayouts_require_rebuild</span>
    <span class="kn">from</span> <span class="nn">CIME.case.preview_namelists</span> <span class="kn">import</span> <span class="n">create_dirs</span><span class="p">,</span> <span class="n">create_namelists</span>
    <span class="kn">from</span> <span class="nn">CIME.case.check_input_data</span> <span class="kn">import</span> <span class="n">check_all_input_data</span><span class="p">,</span> <span class="n">stage_refcase</span><span class="p">,</span> <span class="n">check_input_data</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">case_root</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">read_only</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">case_root</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">case_root</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>

        <span class="n">expect</span><span class="p">(</span><span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">case_root</span><span class="p">)</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">case_root</span><span class="p">,</span><span class="s2">&quot;env_case.xml&quot;</span><span class="p">)),</span> <span class="s2">&quot;Directory </span><span class="si">{}</span><span class="s2"> does not appear to be a valid case directory&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">case_root</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_caseroot</span> <span class="o">=</span> <span class="n">case_root</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Initializing Case.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_read_only_mode</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_force_read_only</span> <span class="o">=</span> <span class="n">read_only</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_primary_component</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_env_entryid_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_env_generic_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_files</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">read_xml</span><span class="p">()</span>

        <span class="c1"># Hold arbitary values. In create_newcase we may set values</span>
        <span class="c1"># for xml files that haven&#39;t been created yet. We need a place</span>
        <span class="c1"># to store them until we are ready to create the file. At file</span>
        <span class="c1"># creation we get the values for those fields from this lookup</span>
        <span class="c1"># table and then remove the entry.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lookups</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_lookup_value</span><span class="p">(</span><span class="s1">&#39;CIMEROOT&#39;</span><span class="p">,</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">get_cime_root</span><span class="p">()))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cime_model</span> <span class="o">=</span> <span class="n">get_model</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_lookup_value</span><span class="p">(</span><span class="s1">&#39;MODEL&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cime_model</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compsetname</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_gridname</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pesfile</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_gridfile</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_components</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_component_classes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_component_description</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_env_loaded</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># these are user_mods as defined in the compset</span>
        <span class="c1"># Command Line user_mods are handled seperately</span>

        <span class="c1"># Derived attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread_count</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_tasks</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tasks_per_node</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_nodes</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spare_nodes</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tasks_per_numa</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cores_per_task</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">srun_binding</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># check if case has been configured and if so initialize derived</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;CASEROOT&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initialize_derived_attributes</span><span class="p">()</span>

<div class="viewcode-block" id="Case.check_if_comp_var">
<a class="viewcode-back" href="../../../CIME_api/CIME.case.html#CIME.case.case.Case.check_if_comp_var">[docs]</a>
    <span class="k">def</span> <span class="nf">check_if_comp_var</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vid</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">env_file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_env_entryid_files</span><span class="p">:</span>
            <span class="n">new_vid</span><span class="p">,</span> <span class="n">new_comp</span><span class="p">,</span> <span class="n">iscompvar</span> <span class="o">=</span> <span class="n">env_file</span><span class="o">.</span><span class="n">check_if_comp_var</span><span class="p">(</span><span class="n">vid</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">iscompvar</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">new_vid</span><span class="p">,</span> <span class="n">new_comp</span><span class="p">,</span> <span class="n">iscompvar</span>

        <span class="k">return</span> <span class="n">vid</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="Case.initialize_derived_attributes">
<a class="viewcode-back" href="../../../CIME_api/CIME.case.html#CIME.case.case.Case.initialize_derived_attributes">[docs]</a>
    <span class="k">def</span> <span class="nf">initialize_derived_attributes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        These are derived variables which can be used in the config_* files</span>
<span class="sd">        for variable substitution using the {{ var }} syntax</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">env_mach_pes</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_env</span><span class="p">(</span><span class="s2">&quot;mach_pes&quot;</span><span class="p">)</span>
        <span class="n">env_mach_spec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_env</span><span class="p">(</span><span class="s1">&#39;mach_specific&#39;</span><span class="p">)</span>
        <span class="n">comp_classes</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_values</span><span class="p">(</span><span class="s2">&quot;COMP_CLASSES&quot;</span><span class="p">)</span>
        <span class="n">max_mpitasks_per_node</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;MAX_MPITASKS_PER_NODE&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">thread_count</span> <span class="o">=</span> <span class="n">env_mach_pes</span><span class="o">.</span><span class="n">get_max_thread_count</span><span class="p">(</span><span class="n">comp_classes</span><span class="p">)</span>

        <span class="n">mpi_attribs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;compiler&quot;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;COMPILER&quot;</span><span class="p">),</span>
            <span class="s2">&quot;mpilib&quot;</span>   <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;MPILIB&quot;</span><span class="p">),</span>
            <span class="s2">&quot;threaded&quot;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_build_threaded</span><span class="p">(),</span>
            <span class="p">}</span>

        <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_primary_job</span><span class="p">()</span>
        <span class="n">executable</span> <span class="o">=</span> <span class="n">env_mach_spec</span><span class="o">.</span><span class="n">get_mpirun</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mpi_attribs</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">exe_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">executable</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s2">&quot;aprun&quot;</span> <span class="ow">in</span> <span class="n">executable</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_nodes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_tasks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks_per_node</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">thread_count</span> <span class="o">=</span> <span class="n">get_aprun_cmd_for_case</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;e3sm.exe&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">spare_nodes</span> <span class="o">=</span> <span class="n">env_mach_pes</span><span class="o">.</span><span class="n">get_spare_nodes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_nodes</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_nodes</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spare_nodes</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">total_tasks</span> <span class="o">=</span> <span class="n">env_mach_pes</span><span class="o">.</span><span class="n">get_total_tasks</span><span class="p">(</span><span class="n">comp_classes</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tasks_per_node</span> <span class="o">=</span> <span class="n">env_mach_pes</span><span class="o">.</span><span class="n">get_tasks_per_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">total_tasks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">thread_count</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">num_nodes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spare_nodes</span> <span class="o">=</span> <span class="n">env_mach_pes</span><span class="o">.</span><span class="n">get_total_nodes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">total_tasks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">thread_count</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_nodes</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spare_nodes</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;total_tasks </span><span class="si">{}</span><span class="s2"> thread_count </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">total_tasks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">thread_count</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tasks_per_numa</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tasks_per_node</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">))</span>
        <span class="n">smt_factor</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;MAX_TASKS_PER_NODE&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="n">max_mpitasks_per_node</span><span class="p">))</span>

        <span class="n">threads_per_node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks_per_node</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">thread_count</span>
        <span class="n">threads_per_core</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="p">(</span><span class="n">threads_per_node</span> <span class="o">&lt;=</span> <span class="n">max_mpitasks_per_node</span><span class="p">)</span> <span class="k">else</span> <span class="n">smt_factor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cores_per_task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">thread_count</span> <span class="o">/</span> <span class="n">threads_per_core</span>

        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;OMP_NUM_THREADS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">thread_count</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">srun_binding</span> <span class="o">=</span> <span class="n">smt_factor</span><span class="o">*</span><span class="n">max_mpitasks_per_node</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks_per_node</span></div>


    <span class="c1"># Define __enter__ and __exit__ so that we can use this as a context manager</span>
    <span class="c1"># and force a flush on exit.</span>
    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_force_read_only</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_read_only_mode</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_read_only_mode</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>

<div class="viewcode-block" id="Case.read_xml">
<a class="viewcode-back" href="../../../CIME_api/CIME.case.html#CIME.case.case.Case.read_xml">[docs]</a>
    <span class="k">def</span> <span class="nf">read_xml</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_env_entryid_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_env_entryid_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">EnvCase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_caseroot</span><span class="p">,</span> <span class="n">components</span><span class="o">=</span><span class="kc">None</span><span class="p">))</span>
        <span class="n">components</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_env_entryid_files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_values</span><span class="p">(</span><span class="s2">&quot;COMP_CLASSES&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_env_entryid_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">EnvRun</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_caseroot</span><span class="p">,</span> <span class="n">components</span><span class="o">=</span><span class="n">components</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_env_entryid_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">EnvBuild</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_caseroot</span><span class="p">,</span> <span class="n">components</span><span class="o">=</span><span class="n">components</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_env_entryid_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">EnvMachPes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_caseroot</span><span class="p">,</span> <span class="n">components</span><span class="o">=</span><span class="n">components</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_env_entryid_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">EnvBatch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_caseroot</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_env_entryid_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">EnvWorkflow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_caseroot</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_caseroot</span><span class="p">,</span><span class="s2">&quot;env_test.xml&quot;</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_env_entryid_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">EnvTest</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_caseroot</span><span class="p">,</span> <span class="n">components</span><span class="o">=</span><span class="n">components</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_env_generic_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_env_generic_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">EnvMachSpecific</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_caseroot</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_env_generic_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">EnvArchive</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_caseroot</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_env_entryid_files</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_env_generic_files</span></div>


<div class="viewcode-block" id="Case.get_case_root">
<a class="viewcode-back" href="../../../CIME_api/CIME.case.html#CIME.case.case.Case.get_case_root">[docs]</a>
    <span class="k">def</span> <span class="nf">get_case_root</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the root directory for this case.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_caseroot</span></div>


<div class="viewcode-block" id="Case.get_env">
<a class="viewcode-back" href="../../../CIME_api/CIME.case.html#CIME.case.case.Case.get_env">[docs]</a>
    <span class="k">def</span> <span class="nf">get_env</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">short_name</span><span class="p">,</span> <span class="n">allow_missing</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">full_name</span> <span class="o">=</span> <span class="s2">&quot;env_</span><span class="si">{}</span><span class="s2">.xml&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">short_name</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">env_file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">env_file</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span> <span class="o">==</span> <span class="n">full_name</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">env_file</span>
        <span class="k">if</span> <span class="n">allow_missing</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">expect</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span><span class="s2">&quot;Could not find object for </span><span class="si">{}</span><span class="s2"> in case&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">full_name</span><span class="p">))</span></div>


<div class="viewcode-block" id="Case.copy">
<a class="viewcode-back" href="../../../CIME_api/CIME.case.html#CIME.case.case.Case.copy">[docs]</a>
    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">newcasename</span><span class="p">,</span> <span class="n">newcaseroot</span><span class="p">,</span> <span class="n">newcimeroot</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">newsrcroot</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">newcase</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">env_file</span> <span class="ow">in</span> <span class="n">newcase</span><span class="o">.</span><span class="n">_files</span><span class="p">:</span> <span class="c1"># pylint: disable=protected-access</span>
            <span class="n">basename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">env_file</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
            <span class="n">newfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">newcaseroot</span><span class="p">,</span> <span class="n">basename</span><span class="p">)</span>
            <span class="n">env_file</span><span class="o">.</span><span class="n">change_file</span><span class="p">(</span><span class="n">newfile</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">newcimeroot</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">newcase</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="s2">&quot;CIMEROOT&quot;</span><span class="p">,</span> <span class="n">newcimeroot</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">newsrcroot</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">newcase</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="s2">&quot;SRCROOT&quot;</span><span class="p">,</span> <span class="n">newsrcroot</span><span class="p">)</span>

        <span class="n">newcase</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="s2">&quot;CASE&quot;</span><span class="p">,</span><span class="n">newcasename</span><span class="p">)</span>
        <span class="n">newcase</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="s2">&quot;CASEROOT&quot;</span><span class="p">,</span><span class="n">newcaseroot</span><span class="p">)</span>
        <span class="n">newcase</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="s2">&quot;CONTINUE_RUN&quot;</span><span class="p">,</span><span class="s2">&quot;FALSE&quot;</span><span class="p">)</span>
        <span class="n">newcase</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="s2">&quot;RESUBMIT&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">newcase</span></div>


<div class="viewcode-block" id="Case.flush">
<a class="viewcode-back" href="../../../CIME_api/CIME.case.html#CIME.case.case.Case.flush">[docs]</a>
    <span class="k">def</span> <span class="nf">flush</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flushall</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_caseroot</span><span class="p">):</span>
            <span class="c1"># do not flush if caseroot wasnt created</span>
            <span class="k">return</span>
        <span class="k">for</span> <span class="n">env_file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="p">:</span>
            <span class="n">env_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">force_write</span><span class="o">=</span><span class="n">flushall</span><span class="p">)</span></div>


<div class="viewcode-block" id="Case.get_values">
<a class="viewcode-back" href="../../../CIME_api/CIME.case.html#CIME.case.case.Case.get_values">[docs]</a>
    <span class="k">def</span> <span class="nf">get_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">attribute</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">resolved</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">subgroup</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">env_file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="p">:</span>
            <span class="c1"># Wait and resolve in self rather than in env_file</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">env_file</span><span class="o">.</span><span class="n">get_values</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">resolved</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">subgroup</span><span class="o">=</span><span class="n">subgroup</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">new_results</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="n">resolved</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
                            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_resolved_value</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
                            <span class="n">vtype</span> <span class="o">=</span> <span class="n">env_file</span><span class="o">.</span><span class="n">get_type_info</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">vtype</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">vtype</span> <span class="o">!=</span> <span class="s2">&quot;char&quot;</span><span class="p">:</span>
                                <span class="n">result</span> <span class="o">=</span> <span class="n">convert_to_type</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">vtype</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>

                            <span class="n">new_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">new_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">new_results</span> <span class="o">=</span> <span class="n">results</span>

                <span class="k">return</span> <span class="n">new_results</span>

        <span class="c1"># Return empty result</span>
        <span class="k">return</span> <span class="p">[]</span></div>


<div class="viewcode-block" id="Case.get_value">
<a class="viewcode-back" href="../../../CIME_api/CIME.case.html#CIME.case.case.Case.get_value">[docs]</a>
    <span class="k">def</span> <span class="nf">get_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">attribute</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">resolved</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">subgroup</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">env_file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="p">:</span>
            <span class="c1"># Wait and resolve in self rather than in env_file</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">env_file</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">resolved</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">subgroup</span><span class="o">=</span><span class="n">subgroup</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">resolved</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_resolved_value</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
                    <span class="n">vtype</span> <span class="o">=</span> <span class="n">env_file</span><span class="o">.</span><span class="n">get_type_info</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">vtype</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">vtype</span> <span class="o">!=</span> <span class="s2">&quot;char&quot;</span><span class="p">:</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="n">convert_to_type</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">vtype</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>

                <span class="k">return</span> <span class="n">result</span>

        <span class="c1"># Return empty result</span>
        <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="Case.get_record_fields">
<a class="viewcode-back" href="../../../CIME_api/CIME.case.html#CIME.case.case.Case.get_record_fields">[docs]</a>
    <span class="k">def</span> <span class="nf">get_record_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">variable</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; get_record_fields gets individual requested field from an entry_id file</span>
<span class="sd">        this routine is used only by xmlquery &quot;&quot;&quot;</span>
        <span class="c1"># Empty result</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">env_file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_env_entryid_files</span><span class="p">:</span>
            <span class="c1"># Wait and resolve in self rather than in env_file</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;(get_record_field) Searching in </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">env_file</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">field</span> <span class="o">==</span> <span class="s2">&quot;varid&quot;</span><span class="p">:</span>
                <span class="n">roots</span> <span class="o">=</span> <span class="n">env_file</span><span class="o">.</span><span class="n">scan_children</span><span class="p">(</span><span class="s2">&quot;entry&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">roots</span> <span class="o">=</span> <span class="n">env_file</span><span class="o">.</span><span class="n">get_nodes_by_id</span><span class="p">(</span><span class="n">variable</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">root</span> <span class="ow">in</span> <span class="n">roots</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">root</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">field</span> <span class="o">==</span> <span class="s2">&quot;raw&quot;</span><span class="p">:</span>
                        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">env_file</span><span class="o">.</span><span class="n">get_raw_record</span><span class="p">(</span><span class="n">root</span><span class="p">))</span>
                    <span class="k">elif</span> <span class="n">field</span> <span class="o">==</span> <span class="s2">&quot;desc&quot;</span><span class="p">:</span>
                        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">env_file</span><span class="o">.</span><span class="n">get_description</span><span class="p">(</span><span class="n">root</span><span class="p">))</span>
                    <span class="k">elif</span> <span class="n">field</span> <span class="o">==</span> <span class="s2">&quot;varid&quot;</span><span class="p">:</span>
                        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">env_file</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">))</span>
                    <span class="k">elif</span> <span class="n">field</span> <span class="o">==</span> <span class="s2">&quot;group&quot;</span><span class="p">:</span>
                        <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">env_file</span><span class="o">.</span><span class="n">get_groups</span><span class="p">(</span><span class="n">root</span><span class="p">))</span>
                    <span class="k">elif</span> <span class="n">field</span> <span class="o">==</span> <span class="s2">&quot;valid_values&quot;</span><span class="p">:</span>
                        <span class="c1"># pylint: disable=protected-access</span>
                        <span class="n">vv</span> <span class="o">=</span> <span class="n">env_file</span><span class="o">.</span><span class="n">_get_valid_values</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">vv</span><span class="p">:</span>
                            <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">vv</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">field</span> <span class="o">==</span> <span class="s2">&quot;file&quot;</span><span class="p">:</span>
                        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">env_file</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">env_file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_env_generic_files</span><span class="p">:</span>
                <span class="n">roots</span> <span class="o">=</span> <span class="n">env_file</span><span class="o">.</span><span class="n">scan_children</span><span class="p">(</span><span class="n">variable</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">root</span> <span class="ow">in</span> <span class="n">roots</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">root</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">field</span> <span class="o">==</span> <span class="s2">&quot;raw&quot;</span><span class="p">:</span>
                            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">env_file</span><span class="o">.</span><span class="n">get_raw_record</span><span class="p">(</span><span class="n">root</span><span class="p">))</span>
                        <span class="k">elif</span> <span class="n">field</span> <span class="o">==</span> <span class="s2">&quot;group&quot;</span><span class="p">:</span>
                            <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">env_file</span><span class="o">.</span><span class="n">get_groups</span><span class="p">(</span><span class="n">root</span><span class="p">))</span>
                        <span class="k">elif</span> <span class="n">field</span> <span class="o">==</span> <span class="s2">&quot;file&quot;</span><span class="p">:</span>
                            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">env_file</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">result</span><span class="p">))</span></div>


<div class="viewcode-block" id="Case.get_type_info">
<a class="viewcode-back" href="../../../CIME_api/CIME.case.html#CIME.case.case.Case.get_type_info">[docs]</a>
    <span class="k">def</span> <span class="nf">get_type_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">env_file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_env_entryid_files</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">env_file</span><span class="o">.</span><span class="n">get_type_info</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">result</span>

        <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="Case.get_resolved_value">
<a class="viewcode-back" href="../../../CIME_api/CIME.case.html#CIME.case.case.Case.get_resolved_value">[docs]</a>
    <span class="k">def</span> <span class="nf">get_resolved_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">recurse</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">allow_unresolved_envvars</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">num_unresolved</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;$&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">item</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">recurse_limit</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">num_unresolved</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">recurse</span> <span class="o">&lt;</span> <span class="n">recurse_limit</span> <span class="p">):</span>
            <span class="k">for</span> <span class="n">env_file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_env_entryid_files</span><span class="p">:</span>
                <span class="n">item</span> <span class="o">=</span> <span class="n">env_file</span><span class="o">.</span><span class="n">get_resolved_value</span><span class="p">(</span><span class="n">item</span><span class="p">,</span>
                                                   <span class="n">allow_unresolved_envvars</span><span class="o">=</span><span class="n">allow_unresolved_envvars</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;$&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">item</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">item</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_resolved_value</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">recurse</span><span class="o">=</span><span class="n">recurse</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
                                               <span class="n">allow_unresolved_envvars</span><span class="o">=</span><span class="n">allow_unresolved_envvars</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">item</span></div>


<div class="viewcode-block" id="Case.set_value">
<a class="viewcode-back" href="../../../CIME_api/CIME.case.html#CIME.case.case.Case.set_value">[docs]</a>
    <span class="k">def</span> <span class="nf">set_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">subgroup</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ignore_type</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">allow_undefined</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        If a file has been defined, and the variable is in the file,</span>
<span class="sd">        then that value will be set in the file object and the file</span>
<span class="sd">        name is returned</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">item</span> <span class="o">==</span> <span class="s2">&quot;CASEROOT&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_caseroot</span> <span class="o">=</span> <span class="n">value</span>
        <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">env_file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">env_file</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">subgroup</span><span class="p">,</span> <span class="n">ignore_type</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Will rewrite file </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">env_file</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">item</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">result</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">expect</span><span class="p">(</span><span class="n">allow_undefined</span> <span class="ow">or</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span>
                   <span class="s2">&quot;No variable </span><span class="si">{}</span><span class="s2"> found in file </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">filename</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">expect</span><span class="p">(</span><span class="n">allow_undefined</span> <span class="ow">or</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span>
                   <span class="s2">&quot;No variable </span><span class="si">{}</span><span class="s2"> found in case&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">item</span><span class="p">))</span></div>


<div class="viewcode-block" id="Case.set_valid_values">
<a class="viewcode-back" href="../../../CIME_api/CIME.case.html#CIME.case.case.Case.set_valid_values">[docs]</a>
    <span class="k">def</span> <span class="nf">set_valid_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">valid_values</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update or create a valid_values entry for item and populate it</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">env_file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_env_entryid_files</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">env_file</span><span class="o">.</span><span class="n">set_valid_values</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">valid_values</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Will rewrite file </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">env_file</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">item</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="Case.set_lookup_value">
<a class="viewcode-back" href="../../../CIME_api/CIME.case.html#CIME.case.case.Case.set_lookup_value">[docs]</a>
    <span class="k">def</span> <span class="nf">set_lookup_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookups</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookups</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Item </span><span class="si">{}</span><span class="s2"> already in lookups with value </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">item</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">lookups</span><span class="p">[</span><span class="n">item</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Setting in lookups: item </span><span class="si">{}</span><span class="s2">, value </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">item</span><span class="p">,</span><span class="n">value</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lookups</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span></div>


<div class="viewcode-block" id="Case.clean_up_lookups">
<a class="viewcode-back" href="../../../CIME_api/CIME.case.html#CIME.case.case.Case.clean_up_lookups">[docs]</a>
    <span class="k">def</span> <span class="nf">clean_up_lookups</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">allow_undefined</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="c1"># put anything in the lookups table into existing env objects</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">value</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lookups</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;lookup key </span><span class="si">{}</span><span class="s2"> value </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">value</span><span class="p">,</span> <span class="n">allow_undefined</span><span class="o">=</span><span class="n">allow_undefined</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookups</span><span class="p">[</span><span class="n">key</span><span class="p">]</span></div>


    <span class="k">def</span> <span class="nf">_set_compset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">compset_name</span><span class="p">,</span> <span class="n">files</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Loop through all the compset files and find the compset</span>
<span class="sd">        specifation file that matches either the input &#39;compset_name&#39;.</span>
<span class="sd">        Note that the input compset name (i.e. compset_name) can be</span>
<span class="sd">        either a longname or an alias. This will set various compset-related</span>
<span class="sd">        info.</span>

<span class="sd">        Returns a tuple: (compset_alias, science_support, component_defining_compset)</span>
<span class="sd">        (For a user-defined compset - i.e., a compset without an alias - these</span>
<span class="sd">        return values will be None, [], None.)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">science_support</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">compset_alias</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">components</span> <span class="o">=</span> <span class="n">files</span><span class="o">.</span><span class="n">get_components</span><span class="p">(</span><span class="s2">&quot;COMPSETS_SPEC_FILE&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot; Possible components for COMPSETS_SPEC_FILE are </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">components</span><span class="p">))</span>

        <span class="c1"># Loop through all of the files listed in COMPSETS_SPEC_FILE and find the file</span>
        <span class="c1"># that has a match for either the alias or the longname in that order</span>
        <span class="k">for</span> <span class="n">component</span> <span class="ow">in</span> <span class="n">components</span><span class="p">:</span>

            <span class="c1"># Determine the compsets file for this component</span>
            <span class="n">compsets_filename</span> <span class="o">=</span> <span class="n">files</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;COMPSETS_SPEC_FILE&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;component&quot;</span><span class="p">:</span><span class="n">component</span><span class="p">})</span>

            <span class="c1"># If the file exists, read it and see if there is a match for the compset alias or longname</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">compsets_filename</span><span class="p">)):</span>
                <span class="n">compsets</span> <span class="o">=</span> <span class="n">Compsets</span><span class="p">(</span><span class="n">compsets_filename</span><span class="p">)</span>
                <span class="n">match</span><span class="p">,</span> <span class="n">compset_alias</span><span class="p">,</span> <span class="n">science_support</span> <span class="o">=</span> <span class="n">compsets</span><span class="o">.</span><span class="n">get_compset_match</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">compset_name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">match</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_compsetname</span> <span class="o">=</span> <span class="n">match</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Compset longname is </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">match</span><span class="p">))</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Compset specification file is </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">compsets_filename</span><span class="p">))</span>
                    <span class="k">return</span> <span class="n">compset_alias</span><span class="p">,</span> <span class="n">science_support</span>

        <span class="k">if</span> <span class="n">compset_alias</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Did not find an alias or longname compset match for </span><span class="si">{}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">compset_name</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_compsetname</span> <span class="o">=</span> <span class="n">compset_name</span>
            <span class="c1"># if this is a valiid compset longname there will be at least 7 components.</span>
            <span class="n">components</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_compset_components</span><span class="p">()</span>
            <span class="n">expect</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">components</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">6</span><span class="p">,</span> <span class="s2">&quot;No compset alias </span><span class="si">{}</span><span class="s2"> found and this does not appear to be a compset longname.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">compset_name</span><span class="p">))</span>

        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">science_support</span>

<div class="viewcode-block" id="Case.get_primary_component">
<a class="viewcode-back" href="../../../CIME_api/CIME.case.html#CIME.case.case.Case.get_primary_component">[docs]</a>
    <span class="k">def</span> <span class="nf">get_primary_component</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_primary_component</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_primary_component</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_primary_component</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_primary_component</span></div>


    <span class="k">def</span> <span class="nf">_find_primary_component</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        try to glean the primary component based on compset name</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">progcomps</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">primary_component</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_component_classes</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">comp</span> <span class="o">==</span> <span class="s2">&quot;CPL&quot;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">spec</span><span class="p">[</span><span class="n">comp</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;COMP_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">comp</span><span class="p">))</span>
            <span class="n">notprogcomps</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;D</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">comp</span><span class="p">),</span><span class="s2">&quot;X</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">comp</span><span class="p">),</span><span class="s2">&quot;S</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">comp</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">spec</span><span class="p">[</span><span class="n">comp</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="n">notprogcomps</span><span class="p">:</span>
                <span class="n">progcomps</span><span class="p">[</span><span class="n">comp</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">progcomps</span><span class="p">[</span><span class="n">comp</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">expect</span><span class="p">(</span><span class="s2">&quot;ATM&quot;</span> <span class="ow">in</span> <span class="n">progcomps</span> <span class="ow">and</span> <span class="s2">&quot;LND&quot;</span> <span class="ow">in</span> <span class="n">progcomps</span> <span class="ow">and</span> <span class="s2">&quot;OCN&quot;</span> <span class="ow">in</span> <span class="n">progcomps</span> <span class="ow">and</span> \
               <span class="s2">&quot;ICE&quot;</span> <span class="ow">in</span> <span class="n">progcomps</span><span class="p">,</span> <span class="s2">&quot; Not finding expected components in </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_component_classes</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">progcomps</span><span class="p">[</span><span class="s2">&quot;ATM&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">progcomps</span><span class="p">[</span><span class="s2">&quot;LND&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">progcomps</span><span class="p">[</span><span class="s2">&quot;OCN&quot;</span><span class="p">]</span> <span class="ow">and</span> \
           <span class="n">progcomps</span><span class="p">[</span><span class="s2">&quot;ICE&quot;</span><span class="p">]:</span>
            <span class="n">primary_component</span> <span class="o">=</span> <span class="s2">&quot;allactive&quot;</span>
        <span class="k">elif</span> <span class="n">progcomps</span><span class="p">[</span><span class="s2">&quot;LND&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">progcomps</span><span class="p">[</span><span class="s2">&quot;OCN&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">progcomps</span><span class="p">[</span><span class="s2">&quot;ICE&quot;</span><span class="p">]:</span>
            <span class="c1"># this is a &quot;J&quot; compset</span>
            <span class="n">primary_component</span> <span class="o">=</span> <span class="s2">&quot;allactive&quot;</span>
        <span class="k">elif</span> <span class="n">progcomps</span><span class="p">[</span><span class="s2">&quot;ATM&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="s2">&quot;DOCN%SOM&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compsetname</span> <span class="ow">and</span> <span class="n">progcomps</span><span class="p">[</span><span class="s2">&quot;LND&quot;</span><span class="p">]:</span>
                <span class="c1"># This is an &quot;E&quot; compset</span>
                <span class="n">primary_component</span> <span class="o">=</span> <span class="s2">&quot;allactive&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># This is an &quot;F&quot; or &quot;Q&quot; compset</span>
                <span class="n">primary_component</span> <span class="o">=</span> <span class="n">spec</span><span class="p">[</span><span class="s2">&quot;ATM&quot;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">progcomps</span><span class="p">[</span><span class="s2">&quot;LND&quot;</span><span class="p">]:</span>
            <span class="c1"># This is an &quot;I&quot; compset</span>
            <span class="n">primary_component</span> <span class="o">=</span> <span class="n">spec</span><span class="p">[</span><span class="s2">&quot;LND&quot;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">progcomps</span><span class="p">[</span><span class="s2">&quot;OCN&quot;</span><span class="p">]:</span>
            <span class="c1"># This is a &quot;C&quot; or &quot;G&quot; compset</span>
            <span class="n">primary_component</span> <span class="o">=</span> <span class="n">spec</span><span class="p">[</span><span class="s2">&quot;OCN&quot;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">progcomps</span><span class="p">[</span><span class="s2">&quot;ICE&quot;</span><span class="p">]:</span>
            <span class="c1"># This is a &quot;D&quot; compset</span>
            <span class="n">primary_component</span> <span class="o">=</span> <span class="n">spec</span><span class="p">[</span><span class="s2">&quot;ICE&quot;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="s2">&quot;GLC&quot;</span> <span class="ow">in</span> <span class="n">progcomps</span> <span class="ow">and</span> <span class="n">progcomps</span><span class="p">[</span><span class="s2">&quot;GLC&quot;</span><span class="p">]:</span>
            <span class="c1"># This is a &quot;TG&quot; compset</span>
            <span class="n">primary_component</span> <span class="o">=</span> <span class="n">spec</span><span class="p">[</span><span class="s2">&quot;GLC&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># This is &quot;A&quot;, &quot;X&quot; or &quot;S&quot;</span>
            <span class="n">primary_component</span> <span class="o">=</span> <span class="s2">&quot;drv&quot;</span>

        <span class="k">return</span> <span class="n">primary_component</span>


    <span class="k">def</span> <span class="nf">_set_info_from_primary_component</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">pesfile</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets file and directory paths that depend on the primary component of</span>
<span class="sd">        this compset.</span>

<span class="sd">        Assumes that self._primary_component has already been set.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">component</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_primary_component</span><span class="p">()</span>

        <span class="n">compset_spec_file</span> <span class="o">=</span> <span class="n">files</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;COMPSETS_SPEC_FILE&quot;</span><span class="p">,</span>
                                            <span class="p">{</span><span class="s2">&quot;component&quot;</span><span class="p">:</span><span class="n">component</span><span class="p">},</span> <span class="n">resolved</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_lookup_value</span><span class="p">(</span><span class="s2">&quot;COMPSETS_SPEC_FILE&quot;</span> <span class="p">,</span><span class="n">compset_spec_file</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pesfile</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pesfile</span> <span class="o">=</span> <span class="n">files</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;PES_SPEC_FILE&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;component&quot;</span><span class="p">:</span><span class="n">component</span><span class="p">})</span>
            <span class="n">pesfile_unresolved</span> <span class="o">=</span> <span class="n">files</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;PES_SPEC_FILE&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;component&quot;</span><span class="p">:</span><span class="n">component</span><span class="p">},</span> <span class="n">resolved</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Pes     specification file is </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pesfile</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pesfile</span> <span class="o">=</span> <span class="n">pesfile</span>
            <span class="n">pesfile_unresolved</span> <span class="o">=</span> <span class="n">pesfile</span>
        <span class="n">expect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pesfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span><span class="s2">&quot;No pesfile found for component </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">component</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_lookup_value</span><span class="p">(</span><span class="s2">&quot;PES_SPEC_FILE&quot;</span><span class="p">,</span> <span class="n">pesfile_unresolved</span><span class="p">)</span>

        <span class="n">tests_filename</span> <span class="o">=</span> <span class="n">files</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;TESTS_SPEC_FILE&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;component&quot;</span><span class="p">:</span><span class="n">component</span><span class="p">},</span> <span class="n">resolved</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">tests_mods_dir</span> <span class="o">=</span> <span class="n">files</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;TESTS_MODS_DIR&quot;</span> <span class="p">,</span> <span class="p">{</span><span class="s2">&quot;component&quot;</span><span class="p">:</span><span class="n">component</span><span class="p">},</span> <span class="n">resolved</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">user_mods_dir</span>  <span class="o">=</span> <span class="n">files</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;USER_MODS_DIR&quot;</span>  <span class="p">,</span> <span class="p">{</span><span class="s2">&quot;component&quot;</span><span class="p">:</span><span class="n">component</span><span class="p">},</span> <span class="n">resolved</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_lookup_value</span><span class="p">(</span><span class="s2">&quot;TESTS_SPEC_FILE&quot;</span><span class="p">,</span> <span class="n">tests_filename</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_lookup_value</span><span class="p">(</span><span class="s2">&quot;TESTS_MODS_DIR&quot;</span> <span class="p">,</span> <span class="n">tests_mods_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_lookup_value</span><span class="p">(</span><span class="s2">&quot;USER_MODS_DIR&quot;</span>  <span class="p">,</span> <span class="n">user_mods_dir</span><span class="p">)</span>


<div class="viewcode-block" id="Case.get_compset_components">
<a class="viewcode-back" href="../../../CIME_api/CIME.case.html#CIME.case.case.Case.get_compset_components">[docs]</a>
    <span class="k">def</span> <span class="nf">get_compset_components</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1">#If are doing a create_clone then, self._compsetname is not set yet</span>
        <span class="n">components</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">compset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;COMPSET&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">compset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">compset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compsetname</span>
        <span class="n">expect</span><span class="p">(</span><span class="n">compset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span>
               <span class="s2">&quot;compset is not set&quot;</span><span class="p">)</span>
        <span class="c1"># the first element is always the date operator - skip it</span>
        <span class="n">elements</span> <span class="o">=</span> <span class="n">compset</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span> <span class="c1"># pylint: disable=maybe-no-member</span>
        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">elements</span><span class="p">:</span>
            <span class="c1"># ignore the possible BGC or TEST modifier</span>
            <span class="k">if</span> <span class="n">element</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;BGC%&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">element</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;TEST&quot;</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">element_component</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;%&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="k">if</span> <span class="s2">&quot;ww&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">element_component</span><span class="p">:</span>
                    <span class="n">element_component</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[0-9]*&#39;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="n">element_component</span><span class="p">)</span>
                <span class="n">components</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">element_component</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">components</span></div>



    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">entryid_file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_env_entryid_files</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">entryid_file</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;$&#39;</span> <span class="ow">in</span> <span class="n">val</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_resolved_value</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span>

<div class="viewcode-block" id="Case.set_comp_classes">
<a class="viewcode-back" href="../../../CIME_api/CIME.case.html#CIME.case.case.Case.set_comp_classes">[docs]</a>
    <span class="k">def</span> <span class="nf">set_comp_classes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">comp_classes</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_component_classes</span> <span class="o">=</span> <span class="n">comp_classes</span>
        <span class="k">for</span> <span class="n">env_file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_env_entryid_files</span><span class="p">:</span>
            <span class="n">env_file</span><span class="o">.</span><span class="n">set_components</span><span class="p">(</span><span class="n">comp_classes</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_get_component_config_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">files</span><span class="p">):</span>
        <span class="c1"># attributes used for multi valued defaults</span>
        <span class="c1"># attlist is a dictionary used to determine the value element that has the most matches</span>
        <span class="n">attlist</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;compset&quot;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">_compsetname</span><span class="p">,</span> <span class="s2">&quot;grid&quot;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">_gridname</span><span class="p">,</span> <span class="s2">&quot;cime_model&quot;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">_cime_model</span><span class="p">}</span>

        <span class="c1"># Determine list of component classes that this coupler/driver knows how</span>
        <span class="c1"># to deal with. This list follows the same order as compset longnames follow.</span>

        <span class="c1"># Add the group and elements for the config_files.xml</span>
        <span class="k">for</span> <span class="n">env_file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_env_entryid_files</span><span class="p">:</span>
            <span class="n">env_file</span><span class="o">.</span><span class="n">add_elements_by_group</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">attlist</span><span class="p">)</span>

        <span class="n">drv_config_file</span> <span class="o">=</span> <span class="n">files</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;CONFIG_CPL_FILE&quot;</span><span class="p">)</span>
        <span class="n">drv_comp</span> <span class="o">=</span> <span class="n">Component</span><span class="p">(</span><span class="n">drv_config_file</span><span class="p">,</span> <span class="s2">&quot;CPL&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">env_file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_env_entryid_files</span><span class="p">:</span>
            <span class="n">env_file</span><span class="o">.</span><span class="n">add_elements_by_group</span><span class="p">(</span><span class="n">drv_comp</span><span class="p">,</span> <span class="n">attributes</span><span class="o">=</span><span class="n">attlist</span><span class="p">)</span>

        <span class="n">drv_config_file_model_specific</span> <span class="o">=</span> <span class="n">files</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;CONFIG_CPL_FILE_MODEL_SPECIFIC&quot;</span><span class="p">)</span>
        <span class="n">drv_comp_model_specific</span> <span class="o">=</span> <span class="n">Component</span><span class="p">(</span><span class="n">drv_config_file_model_specific</span><span class="p">,</span> <span class="s1">&#39;CPL&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_component_description</span><span class="p">[</span><span class="s2">&quot;forcing&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">drv_comp_model_specific</span><span class="o">.</span><span class="n">get_forcing_description</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_compsetname</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Compset forcing is </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_component_description</span><span class="p">[</span><span class="s2">&quot;forcing&quot;</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_component_description</span><span class="p">[</span><span class="s2">&quot;CPL&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">drv_comp_model_specific</span><span class="o">.</span><span class="n">get_description</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_compsetname</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_component_description</span><span class="p">[</span><span class="s2">&quot;CPL&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Com forcing is </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_component_description</span><span class="p">[</span><span class="s2">&quot;CPL&quot;</span><span class="p">]))</span>
        <span class="k">for</span> <span class="n">env_file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_env_entryid_files</span><span class="p">:</span>
            <span class="n">env_file</span><span class="o">.</span><span class="n">add_elements_by_group</span><span class="p">(</span><span class="n">drv_comp_model_specific</span><span class="p">,</span> <span class="n">attributes</span><span class="o">=</span><span class="n">attlist</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">clean_up_lookups</span><span class="p">(</span><span class="n">allow_undefined</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># loop over all elements of both component_classes and components - and get config_component_file for</span>
        <span class="c1"># for each component</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_comp_classes</span><span class="p">(</span><span class="n">drv_comp</span><span class="o">.</span><span class="n">get_valid_model_components</span><span class="p">())</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_component_classes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_components</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_components</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;sesp&#39;</span><span class="p">)</span>

        <span class="c1"># will need a change here for new cpl components</span>
        <span class="n">root_dir_node_name</span> <span class="o">=</span> <span class="s1">&#39;COMP_ROOT_DIR_CPL&#39;</span>
        <span class="n">comp_root_dir</span> <span class="o">=</span> <span class="n">files</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="n">root_dir_node_name</span><span class="p">,</span>
                                        <span class="p">{</span><span class="s2">&quot;component&quot;</span><span class="p">:</span><span class="s2">&quot;drv&quot;</span><span class="p">},</span> <span class="n">resolved</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">comp_root_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">root_dir_node_name</span><span class="p">,</span> <span class="n">comp_root_dir</span><span class="p">)</span>


        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_component_classes</span><span class="p">)):</span>
            <span class="n">comp_class</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_component_classes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">comp_name</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_components</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">root_dir_node_name</span> <span class="o">=</span> <span class="s1">&#39;COMP_ROOT_DIR_&#39;</span> <span class="o">+</span> <span class="n">comp_class</span>
            <span class="n">node_name</span> <span class="o">=</span> <span class="s1">&#39;CONFIG_&#39;</span> <span class="o">+</span> <span class="n">comp_class</span> <span class="o">+</span> <span class="s1">&#39;_FILE&#39;</span>
            <span class="n">comp_root_dir</span> <span class="o">=</span> <span class="n">files</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="n">root_dir_node_name</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;component&quot;</span><span class="p">:</span><span class="n">comp_name</span><span class="p">},</span> <span class="n">resolved</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">comp_root_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">root_dir_node_name</span><span class="p">,</span> <span class="n">comp_root_dir</span><span class="p">)</span>

            <span class="n">compatt</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;component&quot;</span><span class="p">:</span><span class="n">comp_name</span><span class="p">}</span>
            <span class="c1"># Add the group and elements for the config_files.xml</span>
            <span class="n">comp_config_file</span> <span class="o">=</span> <span class="n">files</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="n">node_name</span><span class="p">,</span> <span class="n">compatt</span><span class="p">,</span> <span class="n">resolved</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">expect</span><span class="p">(</span><span class="n">comp_config_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span><span class="s2">&quot;No component </span><span class="si">{}</span><span class="s2"> found for class </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">comp_name</span><span class="p">,</span> <span class="n">comp_class</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">node_name</span><span class="p">,</span> <span class="n">comp_config_file</span><span class="p">)</span>
            <span class="n">comp_config_file</span> <span class="o">=</span>  <span class="n">files</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="n">node_name</span><span class="p">,</span> <span class="n">compatt</span><span class="p">)</span>
            <span class="n">expect</span><span class="p">(</span><span class="n">comp_config_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">comp_config_file</span><span class="p">),</span>
                   <span class="s2">&quot;Config file </span><span class="si">{}</span><span class="s2"> for component </span><span class="si">{}</span><span class="s2"> not found.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">comp_config_file</span><span class="p">,</span> <span class="n">comp_name</span><span class="p">))</span>
            <span class="n">compobj</span> <span class="o">=</span> <span class="n">Component</span><span class="p">(</span><span class="n">comp_config_file</span><span class="p">,</span> <span class="n">comp_class</span><span class="p">)</span>
            <span class="c1"># For files following version 3 schema this also checks the compsetname validity</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_component_description</span><span class="p">[</span><span class="n">comp_class</span><span class="p">]</span> <span class="o">=</span> <span class="n">compobj</span><span class="o">.</span><span class="n">get_description</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_compsetname</span><span class="p">)</span>
            <span class="n">expect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_component_description</span><span class="p">[</span><span class="n">comp_class</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span><span class="s2">&quot;No description found in file </span><span class="si">{}</span><span class="s2"> for component </span><span class="si">{}</span><span class="s2"> in comp_class </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">comp_config_file</span><span class="p">,</span> <span class="n">comp_name</span><span class="p">,</span> <span class="n">comp_class</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> component is </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">comp_class</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_component_description</span><span class="p">[</span><span class="n">comp_class</span><span class="p">]))</span>
            <span class="k">for</span> <span class="n">env_file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_env_entryid_files</span><span class="p">:</span>
                <span class="n">env_file</span><span class="o">.</span><span class="n">add_elements_by_group</span><span class="p">(</span><span class="n">compobj</span><span class="p">,</span> <span class="n">attributes</span><span class="o">=</span><span class="n">attlist</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">clean_up_lookups</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_setup_mach_pes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pecount</span><span class="p">,</span> <span class="n">multi_driver</span><span class="p">,</span> <span class="n">ninst</span><span class="p">,</span> <span class="n">machine_name</span><span class="p">,</span> <span class="n">mpilib</span><span class="p">):</span>
        <span class="c1">#--------------------------------------------</span>
        <span class="c1"># pe layout</span>
        <span class="c1">#--------------------------------------------</span>
        <span class="n">mach_pes_obj</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># self._pesfile may already be env_mach_pes.xml if so we can just return</span>
        <span class="n">gfile</span> <span class="o">=</span> <span class="n">GenericXML</span><span class="p">(</span><span class="n">infile</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_pesfile</span><span class="p">)</span>
        <span class="n">ftype</span> <span class="o">=</span> <span class="n">gfile</span><span class="o">.</span><span class="n">get_id</span><span class="p">()</span>
        <span class="n">expect</span><span class="p">(</span><span class="n">ftype</span> <span class="o">==</span> <span class="s2">&quot;env_mach_pes.xml&quot;</span> <span class="ow">or</span> <span class="n">ftype</span> <span class="o">==</span> <span class="s2">&quot;config_pes&quot;</span><span class="p">,</span> <span class="s2">&quot; Do not recognize </span><span class="si">{}</span><span class="s2"> as a valid CIME pes file </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pesfile</span><span class="p">,</span> <span class="n">ftype</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">ftype</span> <span class="o">==</span> <span class="s2">&quot;env_mach_pes.xml&quot;</span><span class="p">:</span>
            <span class="n">new_mach_pes_obj</span> <span class="o">=</span> <span class="n">EnvMachPes</span><span class="p">(</span><span class="n">infile</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_pesfile</span><span class="p">,</span> <span class="n">components</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_component_classes</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_env</span><span class="p">(</span><span class="n">new_mach_pes_obj</span><span class="p">,</span> <span class="s2">&quot;mach_pes&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">new_mach_pes_obj</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;TOTALPES&quot;</span><span class="p">)</span>

        <span class="n">pesobj</span> <span class="o">=</span> <span class="n">Pes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pesfile</span><span class="p">)</span>

        <span class="n">match1</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;(.+)x([0-9]+)&#39;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="n">pecount</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">pecount</span><span class="p">)</span>
        <span class="n">match2</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;([0-9]+)&#39;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="n">pecount</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">pecount</span><span class="p">)</span>

        <span class="n">pes_ntasks</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">pes_nthrds</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">pes_rootpe</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">pes_pstrid</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">other</span>      <span class="o">=</span> <span class="p">{}</span>
        <span class="n">comment</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">force_tasks</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">force_thrds</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">match1</span><span class="p">:</span>
            <span class="n">opti_tasks</span> <span class="o">=</span> <span class="n">match1</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">opti_tasks</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                <span class="n">force_tasks</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">opti_tasks</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pes_ntasks</span> <span class="o">=</span> <span class="n">pesobj</span><span class="o">.</span><span class="n">find_pes_layout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_gridname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compsetname</span><span class="p">,</span> <span class="n">machine_name</span><span class="p">,</span>
                                                    <span class="n">pesize_opts</span><span class="o">=</span><span class="n">opti_tasks</span><span class="p">,</span> <span class="n">mpilib</span><span class="o">=</span><span class="n">mpilib</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">force_thrds</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">match1</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">match2</span><span class="p">:</span>
            <span class="n">force_tasks</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">match2</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">pes_nthrds</span> <span class="o">=</span> <span class="n">pesobj</span><span class="o">.</span><span class="n">find_pes_layout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_gridname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compsetname</span><span class="p">,</span> <span class="n">machine_name</span><span class="p">,</span> <span class="n">mpilib</span><span class="o">=</span><span class="n">mpilib</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pes_ntasks</span><span class="p">,</span> <span class="n">pes_nthrds</span><span class="p">,</span> <span class="n">pes_rootpe</span><span class="p">,</span> <span class="n">pes_pstrid</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">comment</span> <span class="o">=</span> <span class="n">pesobj</span><span class="o">.</span><span class="n">find_pes_layout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_gridname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compsetname</span><span class="p">,</span>
                                                                               <span class="n">machine_name</span><span class="p">,</span> <span class="n">pesize_opts</span><span class="o">=</span><span class="n">pecount</span><span class="p">,</span> <span class="n">mpilib</span><span class="o">=</span><span class="n">mpilib</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">match1</span> <span class="ow">or</span> <span class="n">match2</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">component_class</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_component_classes</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">force_tasks</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">string_</span> <span class="o">=</span> <span class="s2">&quot;NTASKS_&quot;</span> <span class="o">+</span> <span class="n">component_class</span>
                    <span class="n">pes_ntasks</span><span class="p">[</span><span class="n">string_</span><span class="p">]</span> <span class="o">=</span> <span class="n">force_tasks</span>

                <span class="k">if</span> <span class="n">force_thrds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">string_</span> <span class="o">=</span> <span class="s2">&quot;NTHRDS_&quot;</span> <span class="o">+</span> <span class="n">component_class</span>
                    <span class="n">pes_nthrds</span><span class="p">[</span><span class="n">string_</span><span class="p">]</span> <span class="o">=</span> <span class="n">force_thrds</span>

                <span class="c1"># Always default to zero rootpe if user forced procs and or threads</span>
                <span class="n">string_</span> <span class="o">=</span> <span class="s2">&quot;ROOTPE_&quot;</span> <span class="o">+</span> <span class="n">component_class</span>
                <span class="n">pes_rootpe</span><span class="p">[</span><span class="n">string_</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">mach_pes_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_env</span><span class="p">(</span><span class="s2">&quot;mach_pes&quot;</span><span class="p">)</span>
        <span class="n">mach_pes_obj</span><span class="o">.</span><span class="n">add_comment</span><span class="p">(</span><span class="n">comment</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">other</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">other</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

        <span class="n">totaltasks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">comp_class</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_component_classes</span><span class="p">:</span>
            <span class="n">ntasks_str</span> <span class="o">=</span> <span class="s2">&quot;NTASKS_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">comp_class</span><span class="p">)</span>
            <span class="n">nthrds_str</span> <span class="o">=</span> <span class="s2">&quot;NTHRDS_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">comp_class</span><span class="p">)</span>
            <span class="n">rootpe_str</span> <span class="o">=</span> <span class="s2">&quot;ROOTPE_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">comp_class</span><span class="p">)</span>
            <span class="n">pstrid_str</span> <span class="o">=</span> <span class="s2">&quot;PSTRID_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">comp_class</span><span class="p">)</span>

            <span class="n">ntasks</span> <span class="o">=</span> <span class="n">pes_ntasks</span><span class="p">[</span><span class="n">ntasks_str</span><span class="p">]</span> <span class="k">if</span> <span class="n">ntasks_str</span> <span class="ow">in</span> <span class="n">pes_ntasks</span> <span class="k">else</span> <span class="mi">1</span>
            <span class="n">nthrds</span> <span class="o">=</span> <span class="n">pes_nthrds</span><span class="p">[</span><span class="n">nthrds_str</span><span class="p">]</span> <span class="k">if</span> <span class="n">nthrds_str</span> <span class="ow">in</span> <span class="n">pes_nthrds</span> <span class="k">else</span> <span class="mi">1</span>
            <span class="n">rootpe</span> <span class="o">=</span> <span class="n">pes_rootpe</span><span class="p">[</span><span class="n">rootpe_str</span><span class="p">]</span> <span class="k">if</span> <span class="n">rootpe_str</span> <span class="ow">in</span> <span class="n">pes_rootpe</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="n">pstrid</span> <span class="o">=</span> <span class="n">pes_pstrid</span><span class="p">[</span><span class="n">pstrid_str</span><span class="p">]</span> <span class="k">if</span> <span class="n">pstrid_str</span> <span class="ow">in</span> <span class="n">pes_pstrid</span> <span class="k">else</span> <span class="mi">1</span>

            <span class="n">totaltasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">(</span><span class="n">ntasks</span> <span class="o">+</span> <span class="n">rootpe</span><span class="p">)</span> <span class="o">*</span> <span class="n">nthrds</span> <span class="p">)</span>

            <span class="n">mach_pes_obj</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">ntasks_str</span><span class="p">,</span> <span class="n">ntasks</span><span class="p">)</span>
            <span class="n">mach_pes_obj</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">nthrds_str</span><span class="p">,</span> <span class="n">nthrds</span><span class="p">)</span>
            <span class="n">mach_pes_obj</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">rootpe_str</span><span class="p">,</span> <span class="n">rootpe</span><span class="p">)</span>
            <span class="n">mach_pes_obj</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">pstrid_str</span><span class="p">,</span> <span class="n">pstrid</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">multi_driver</span><span class="p">:</span>
            <span class="n">mach_pes_obj</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="s2">&quot;MULTI_DRIVER&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Make sure that every component has been accounted for</span>
        <span class="c1"># set, nthrds and ntasks to 1 otherwise. Also set the ninst values here.</span>
        <span class="k">for</span> <span class="n">compclass</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_component_classes</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;NINST_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">compclass</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">compclass</span> <span class="o">==</span> <span class="s2">&quot;CPL&quot;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">mach_pes_obj</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">ninst</span><span class="p">)</span>

            <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;NTASKS_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">compclass</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pes_ntasks</span><span class="p">:</span>
                <span class="n">mach_pes_obj</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;NTHRDS_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">compclass</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">compclass</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pes_nthrds</span><span class="p">:</span>
                <span class="n">mach_pes_obj</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">compclass</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

<div class="viewcode-block" id="Case.configure">
<a class="viewcode-back" href="../../../CIME_api/CIME.case.html#CIME.case.case.Case.configure">[docs]</a>
    <span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">compset_name</span><span class="p">,</span> <span class="n">grid_name</span><span class="p">,</span> <span class="n">machine_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">project</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pecount</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">compiler</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mpilib</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">pesfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">gridfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">multi_driver</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ninst</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">test</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                  <span class="n">walltime</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">queue</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output_root</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">run_unsupported</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">answer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">input_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">workflowid</span><span class="o">=</span><span class="s2">&quot;default&quot;</span><span class="p">):</span>

        <span class="n">expect</span><span class="p">(</span><span class="n">check_name</span><span class="p">(</span><span class="n">compset_name</span><span class="p">,</span> <span class="n">additional_chars</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">),</span> <span class="s2">&quot;Invalid compset name </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">compset_name</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">driver</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_lookup_value</span><span class="p">(</span><span class="s2">&quot;COMP_INTERFACE&quot;</span><span class="p">,</span> <span class="n">driver</span><span class="p">)</span>

        <span class="c1">#--------------------------------------------</span>
        <span class="c1"># compset, pesfile, and compset components</span>
        <span class="c1">#--------------------------------------------</span>
        <span class="n">files</span> <span class="o">=</span> <span class="n">Files</span><span class="p">()</span>
        <span class="n">compset_alias</span><span class="p">,</span> <span class="n">science_support</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_compset</span><span class="p">(</span>
            <span class="n">compset_name</span><span class="p">,</span> <span class="n">files</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_components</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_compset_components</span><span class="p">()</span>

        <span class="c1">#--------------------------------------------</span>
        <span class="c1"># grid</span>
        <span class="c1">#--------------------------------------------</span>
        <span class="n">grids</span> <span class="o">=</span> <span class="n">Grids</span><span class="p">(</span><span class="n">gridfile</span><span class="p">)</span>

        <span class="n">gridinfo</span> <span class="o">=</span> <span class="n">grids</span><span class="o">.</span><span class="n">get_grid_info</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">grid_name</span><span class="p">,</span> <span class="n">compset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_compsetname</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_gridname</span> <span class="o">=</span> <span class="n">gridinfo</span><span class="p">[</span><span class="s2">&quot;GRID&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">value</span> <span class="ow">in</span> <span class="n">gridinfo</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Set grid </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">value</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_lookup_value</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">value</span><span class="p">)</span>

        <span class="c1">#--------------------------------------------</span>
        <span class="c1"># component config data</span>
        <span class="c1">#--------------------------------------------</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_component_config_data</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>

        <span class="c1"># This needs to be called after self.set_comp_classes, which is called</span>
        <span class="c1"># from self._get_component_config_data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_primary_component</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_primary_component</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_set_info_from_primary_component</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">pesfile</span><span class="o">=</span><span class="n">pesfile</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">clean_up_lookups</span><span class="p">(</span><span class="n">allow_undefined</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">get_compset_var_settings</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">clean_up_lookups</span><span class="p">(</span><span class="n">allow_undefined</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1">#--------------------------------------------</span>
        <span class="c1"># machine</span>
        <span class="c1">#--------------------------------------------</span>
        <span class="c1"># set machine values in env_xxx files</span>
        <span class="n">machobj</span> <span class="o">=</span> <span class="n">Machines</span><span class="p">(</span><span class="n">machine</span><span class="o">=</span><span class="n">machine_name</span><span class="p">)</span>
        <span class="n">probed_machine</span> <span class="o">=</span> <span class="n">machobj</span><span class="o">.</span><span class="n">probe_machine_name</span><span class="p">()</span>
        <span class="n">machine_name</span> <span class="o">=</span> <span class="n">machobj</span><span class="o">.</span><span class="n">get_machine_name</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="s2">&quot;MACH&quot;</span><span class="p">,</span> <span class="n">machine_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">probed_machine</span> <span class="o">!=</span> <span class="n">machine_name</span> <span class="ow">and</span> <span class="n">probed_machine</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;WARNING: User-selected machine &#39;</span><span class="si">{}</span><span class="s2">&#39; does not match probed machine &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">machine_name</span><span class="p">,</span> <span class="n">probed_machine</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Machine is </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">machine_name</span><span class="p">))</span>

        <span class="n">nodenames</span> <span class="o">=</span> <span class="n">machobj</span><span class="o">.</span><span class="n">get_node_names</span><span class="p">()</span>
        <span class="n">nodenames</span> <span class="o">=</span>  <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">nodenames</span> <span class="k">if</span>
                      <span class="s1">&#39;_system&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">x</span> <span class="ow">and</span> <span class="s1">&#39;_variables&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">x</span> <span class="ow">and</span> <span class="s1">&#39;mpirun&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">x</span> <span class="ow">and</span>\
                      <span class="s1">&#39;COMPILER&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">x</span> <span class="ow">and</span> <span class="s1">&#39;MPILIB&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">nodename</span> <span class="ow">in</span> <span class="n">nodenames</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">machobj</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="n">nodename</span><span class="p">,</span> <span class="n">resolved</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
                <span class="n">type_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_type_info</span><span class="p">(</span><span class="n">nodename</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">type_str</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;machine nodname </span><span class="si">{}</span><span class="s2"> value </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nodename</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">nodename</span><span class="p">,</span> <span class="n">convert_to_type</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">type_str</span><span class="p">,</span> <span class="n">nodename</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">compiler</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">compiler</span> <span class="o">=</span> <span class="n">machobj</span><span class="o">.</span><span class="n">get_default_compiler</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">expect</span><span class="p">(</span><span class="n">machobj</span><span class="o">.</span><span class="n">is_valid_compiler</span><span class="p">(</span><span class="n">compiler</span><span class="p">),</span>
                   <span class="s2">&quot;compiler </span><span class="si">{}</span><span class="s2"> is not supported on machine </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">compiler</span><span class="p">,</span> <span class="n">machine_name</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="s2">&quot;COMPILER&quot;</span><span class="p">,</span><span class="n">compiler</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">mpilib</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mpilib</span> <span class="o">=</span> <span class="n">machobj</span><span class="o">.</span><span class="n">get_default_MPIlib</span><span class="p">({</span><span class="s2">&quot;compiler&quot;</span><span class="p">:</span><span class="n">compiler</span><span class="p">})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">expect</span><span class="p">(</span><span class="n">machobj</span><span class="o">.</span><span class="n">is_valid_MPIlib</span><span class="p">(</span><span class="n">mpilib</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;compiler&quot;</span><span class="p">:</span><span class="n">compiler</span><span class="p">}),</span>
                   <span class="s2">&quot;MPIlib </span><span class="si">{}</span><span class="s2"> is not supported on machine </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mpilib</span><span class="p">,</span> <span class="n">machine_name</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="s2">&quot;MPILIB&quot;</span><span class="p">,</span><span class="n">mpilib</span><span class="p">)</span>

        <span class="n">machdir</span> <span class="o">=</span> <span class="n">machobj</span><span class="o">.</span><span class="n">get_machines_dir</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="s2">&quot;MACHDIR&quot;</span><span class="p">,</span> <span class="n">machdir</span><span class="p">)</span>

        <span class="c1"># Create env_mach_specific settings from machine info.</span>
        <span class="n">env_mach_specific_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_env</span><span class="p">(</span><span class="s2">&quot;mach_specific&quot;</span><span class="p">)</span>
        <span class="n">env_mach_specific_obj</span><span class="o">.</span><span class="n">populate</span><span class="p">(</span><span class="n">machobj</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_mach_pes</span><span class="p">(</span><span class="n">pecount</span><span class="p">,</span> <span class="n">multi_driver</span><span class="p">,</span> <span class="n">ninst</span><span class="p">,</span> <span class="n">machine_name</span><span class="p">,</span> <span class="n">mpilib</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">multi_driver</span> <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="n">ninst</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot; Driver/Coupler has </span><span class="si">%s</span><span class="s2"> instances&quot;</span> <span class="o">%</span> <span class="n">ninst</span><span class="p">)</span>

        <span class="c1">#--------------------------------------------</span>
        <span class="c1"># archiving system</span>
        <span class="c1">#--------------------------------------------</span>
        <span class="n">env_archive</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_env</span><span class="p">(</span><span class="s2">&quot;archive&quot;</span><span class="p">)</span>
        <span class="n">infile_node</span> <span class="o">=</span> <span class="n">files</span><span class="o">.</span><span class="n">get_child</span><span class="p">(</span><span class="s2">&quot;entry&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span><span class="s2">&quot;ARCHIVE_SPEC_FILE&quot;</span><span class="p">})</span>
        <span class="n">infile</span> <span class="o">=</span> <span class="n">files</span><span class="o">.</span><span class="n">get_default_value</span><span class="p">(</span><span class="n">infile_node</span><span class="p">)</span>
        <span class="n">infile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_resolved_value</span><span class="p">(</span><span class="n">infile</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;archive defaults located in </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">infile</span><span class="p">))</span>
        <span class="n">archive</span> <span class="o">=</span> <span class="n">Archive</span><span class="p">(</span><span class="n">infile</span><span class="o">=</span><span class="n">infile</span><span class="p">,</span> <span class="n">files</span><span class="o">=</span><span class="n">files</span><span class="p">)</span>
        <span class="n">archive</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">env_archive</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_components</span><span class="p">,</span> <span class="n">files</span><span class="o">=</span><span class="n">files</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="s2">&quot;COMPSET&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_compsetname</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_set_pio_xml</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot; Compset is: </span><span class="si">{}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_compsetname</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot; Grid is: </span><span class="si">{}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_gridname</span> <span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot; Components in compset are: </span><span class="si">{}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_components</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">test</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">run_unsupported</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cime_model</span> <span class="o">==</span> <span class="s2">&quot;cesm&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">grid_name</span> <span class="ow">in</span> <span class="n">science_support</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">This is a CESM scientifically supported compset at this resolution.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_check_testlists</span><span class="p">(</span><span class="n">compset_alias</span><span class="p">,</span> <span class="n">grid_name</span><span class="p">,</span> <span class="n">files</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="s2">&quot;REALUSER&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;USER&quot;</span><span class="p">])</span>

        <span class="c1"># Set project id</span>
        <span class="k">if</span> <span class="n">project</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">project</span> <span class="o">=</span> <span class="n">get_project</span><span class="p">(</span><span class="n">machobj</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">project</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="s2">&quot;PROJECT&quot;</span><span class="p">,</span> <span class="n">project</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">machobj</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;PROJECT_REQUIRED&quot;</span><span class="p">):</span>
            <span class="n">expect</span><span class="p">(</span><span class="n">project</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;PROJECT_REQUIRED is true but no project found&quot;</span><span class="p">)</span>
        <span class="c1"># Get charge_account id if it exists</span>
        <span class="n">charge_account</span> <span class="o">=</span> <span class="n">get_charge_account</span><span class="p">(</span><span class="n">machobj</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">charge_account</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="s2">&quot;CHARGE_ACCOUNT&quot;</span><span class="p">,</span> <span class="n">charge_account</span><span class="p">)</span>

        <span class="c1"># Resolve the CIME_OUTPUT_ROOT variable, other than this</span>
        <span class="c1"># we don&#39;t want to resolve variables until we need them</span>
        <span class="k">if</span> <span class="n">output_root</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">output_root</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;CIME_OUTPUT_ROOT&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="s2">&quot;CIME_OUTPUT_ROOT&quot;</span><span class="p">,</span> <span class="n">output_root</span><span class="p">)</span>

        <span class="c1"># Overwriting an existing exeroot or rundir can cause problems</span>
        <span class="n">exeroot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;EXEROOT&quot;</span><span class="p">)</span>
        <span class="n">rundir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;RUNDIR&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">wdir</span> <span class="ow">in</span> <span class="p">(</span><span class="n">exeroot</span><span class="p">,</span> <span class="n">rundir</span><span class="p">):</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;wdir is </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">wdir</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">wdir</span><span class="p">):</span>
                <span class="n">expect</span><span class="p">(</span><span class="ow">not</span> <span class="n">test</span><span class="p">,</span> <span class="s2">&quot;Directory </span><span class="si">{}</span><span class="s2"> already exists, aborting test&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">wdir</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">answer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">response</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Directory </span><span class="si">{}</span><span class="s2"> already exists, (r)eplace, (a)bort, or (u)se existing?&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">wdir</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">response</span> <span class="o">=</span> <span class="n">answer</span>

                <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">):</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">wdir</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;u&quot;</span><span class="p">),</span> <span class="s2">&quot;Aborting by user request&quot;</span><span class="p">)</span>

        <span class="c1"># miscellaneous settings</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;RUN_TYPE&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;hybrid&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="s2">&quot;GET_REFCASE&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Turn on short term archiving as cesm default setting</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">get_model</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_model_version</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">model</span> <span class="o">==</span> <span class="s2">&quot;cesm&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">test</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="s2">&quot;DOUT_S&quot;</span><span class="p">,</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="s2">&quot;TIMER_LEVEL&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">test</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="s2">&quot;TEST&quot;</span><span class="p">,</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">initialize_derived_attributes</span><span class="p">()</span>

        <span class="c1">#--------------------------------------------</span>
        <span class="c1"># batch system (must come after initialize_derived_attributes)</span>
        <span class="c1">#--------------------------------------------</span>
        <span class="n">env_batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_env</span><span class="p">(</span><span class="s2">&quot;batch&quot;</span><span class="p">)</span>

        <span class="n">batch_system_type</span> <span class="o">=</span> <span class="n">machobj</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;BATCH_SYSTEM&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Batch_system_type is </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">batch_system_type</span><span class="p">))</span>
        <span class="n">batch</span> <span class="o">=</span> <span class="n">Batch</span><span class="p">(</span><span class="n">batch_system</span><span class="o">=</span><span class="n">batch_system_type</span><span class="p">,</span> <span class="n">machine</span><span class="o">=</span><span class="n">machine_name</span><span class="p">,</span> <span class="n">files</span><span class="o">=</span><span class="n">files</span><span class="p">)</span>
        <span class="n">workflow</span> <span class="o">=</span> <span class="n">Workflow</span><span class="p">(</span><span class="n">files</span><span class="o">=</span><span class="n">files</span><span class="p">)</span>
        <span class="n">bjobs</span> <span class="o">=</span> <span class="n">workflow</span><span class="o">.</span><span class="n">get_workflow_jobs</span><span class="p">(</span><span class="n">machine</span><span class="o">=</span><span class="n">machine_name</span><span class="p">,</span> <span class="n">workflowid</span><span class="o">=</span><span class="n">workflowid</span><span class="p">)</span>
        <span class="n">env_workflow</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_env</span><span class="p">(</span><span class="s2">&quot;workflow&quot;</span><span class="p">)</span>

        <span class="n">env_batch</span><span class="o">.</span><span class="n">set_batch_system</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">batch_system_type</span><span class="o">=</span><span class="n">batch_system_type</span><span class="p">)</span>
        <span class="n">env_workflow</span><span class="o">.</span><span class="n">create_job_groups</span><span class="p">(</span><span class="n">bjobs</span><span class="p">,</span> <span class="n">test</span><span class="p">)</span>
        <span class="n">env_batch</span><span class="o">.</span><span class="n">set_job_defaults</span><span class="p">(</span><span class="n">bjobs</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">walltime</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="s2">&quot;USER_REQUESTED_WALLTIME&quot;</span><span class="p">,</span> <span class="n">walltime</span><span class="p">,</span> <span class="n">subgroup</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_primary_job</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">queue</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="s2">&quot;USER_REQUESTED_QUEUE&quot;</span><span class="p">,</span> <span class="n">queue</span><span class="p">,</span> <span class="n">subgroup</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_primary_job</span><span class="p">())</span>

        <span class="c1"># Make sure that parallel IO is not specified if total_tasks==1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_tasks</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">compclass</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_component_classes</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;PIO_TYPENAME_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">compclass</span><span class="p">)</span>
                <span class="n">pio_typename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">pio_typename</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;pnetcdf&quot;</span><span class="p">,</span> <span class="s2">&quot;netcdf4p&quot;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s2">&quot;netcdf&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">input_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="s2">&quot;DIN_LOC_ROOT&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">input_dir</span><span class="p">))</span></div>


<div class="viewcode-block" id="Case.get_compset_var_settings">
<a class="viewcode-back" href="../../../CIME_api/CIME.case.html#CIME.case.case.Case.get_compset_var_settings">[docs]</a>
    <span class="k">def</span> <span class="nf">get_compset_var_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">compset_obj</span> <span class="o">=</span> <span class="n">Compsets</span><span class="p">(</span><span class="n">infile</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;COMPSETS_SPEC_FILE&quot;</span><span class="p">))</span>
        <span class="n">matches</span> <span class="o">=</span> <span class="n">compset_obj</span><span class="o">.</span><span class="n">get_compset_var_settings</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_compsetname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gridname</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Compset specific settings: name is </span><span class="si">{}</span><span class="s2"> and value is </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_lookup_value</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></div>


<div class="viewcode-block" id="Case.set_initial_test_values">
<a class="viewcode-back" href="../../../CIME_api/CIME.case.html#CIME.case.case.Case.set_initial_test_values">[docs]</a>
    <span class="k">def</span> <span class="nf">set_initial_test_values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">testobj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_env</span><span class="p">(</span><span class="s2">&quot;test&quot;</span><span class="p">)</span>
        <span class="n">testobj</span><span class="o">.</span><span class="n">set_initial_values</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>


<div class="viewcode-block" id="Case.get_batch_jobs">
<a class="viewcode-back" href="../../../CIME_api/CIME.case.html#CIME.case.case.Case.get_batch_jobs">[docs]</a>
    <span class="k">def</span> <span class="nf">get_batch_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">batchobj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_env</span><span class="p">(</span><span class="s2">&quot;batch&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">batchobj</span><span class="o">.</span><span class="n">get_jobs</span><span class="p">()</span></div>


    <span class="k">def</span> <span class="nf">_set_pio_xml</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">pioobj</span> <span class="o">=</span> <span class="n">PIO</span><span class="p">()</span>
        <span class="n">grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;GRID&quot;</span><span class="p">)</span>
        <span class="n">compiler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;COMPILER&quot;</span><span class="p">)</span>
        <span class="n">mach</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;MACH&quot;</span><span class="p">)</span>
        <span class="n">compset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;COMPSET&quot;</span><span class="p">)</span>
        <span class="n">mpilib</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;MPILIB&quot;</span><span class="p">)</span>
        <span class="n">defaults</span> <span class="o">=</span> <span class="n">pioobj</span><span class="o">.</span><span class="n">get_defaults</span><span class="p">(</span><span class="n">grid</span><span class="o">=</span><span class="n">grid</span><span class="p">,</span><span class="n">compset</span><span class="o">=</span><span class="n">compset</span><span class="p">,</span><span class="n">mach</span><span class="o">=</span><span class="n">mach</span><span class="p">,</span><span class="n">compiler</span><span class="o">=</span><span class="n">compiler</span><span class="p">,</span> <span class="n">mpilib</span><span class="o">=</span><span class="n">mpilib</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">vid</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">defaults</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">vid</span><span class="p">,</span><span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_create_caseroot_tools</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">machines_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;MACHDIR&quot;</span><span class="p">))</span>
        <span class="n">machine</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;MACH&quot;</span><span class="p">)</span>
        <span class="n">toolsdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;CIMEROOT&quot;</span><span class="p">),</span><span class="s2">&quot;scripts&quot;</span><span class="p">,</span><span class="s2">&quot;Tools&quot;</span><span class="p">)</span>
        <span class="n">casetools</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_caseroot</span><span class="p">,</span> <span class="s2">&quot;Tools&quot;</span><span class="p">)</span>
        <span class="c1"># setup executable files in caseroot/</span>
        <span class="n">exefiles</span> <span class="o">=</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">toolsdir</span><span class="p">,</span> <span class="s2">&quot;case.setup&quot;</span><span class="p">),</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">toolsdir</span><span class="p">,</span> <span class="s2">&quot;case.build&quot;</span><span class="p">),</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">toolsdir</span><span class="p">,</span> <span class="s2">&quot;case.submit&quot;</span><span class="p">),</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">toolsdir</span><span class="p">,</span> <span class="s2">&quot;case.qstatus&quot;</span><span class="p">),</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">toolsdir</span><span class="p">,</span> <span class="s2">&quot;case.cmpgen_namelists&quot;</span><span class="p">),</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">toolsdir</span><span class="p">,</span> <span class="s2">&quot;preview_namelists&quot;</span><span class="p">),</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">toolsdir</span><span class="p">,</span> <span class="s2">&quot;preview_run&quot;</span><span class="p">),</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">toolsdir</span><span class="p">,</span> <span class="s2">&quot;check_input_data&quot;</span><span class="p">),</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">toolsdir</span><span class="p">,</span> <span class="s2">&quot;check_case&quot;</span><span class="p">),</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">toolsdir</span><span class="p">,</span> <span class="s2">&quot;xmlchange&quot;</span><span class="p">),</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">toolsdir</span><span class="p">,</span> <span class="s2">&quot;xmlquery&quot;</span><span class="p">),</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">toolsdir</span><span class="p">,</span> <span class="s2">&quot;pelayout&quot;</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">exefile</span> <span class="ow">in</span> <span class="n">exefiles</span><span class="p">:</span>
                <span class="n">destfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_caseroot</span><span class="p">,</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">exefile</span><span class="p">))</span>
                <span class="n">os</span><span class="o">.</span><span class="n">symlink</span><span class="p">(</span><span class="n">exefile</span><span class="p">,</span> <span class="n">destfile</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;FAILED to set up exefiles: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>

        <span class="n">toolfiles</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">toolsdir</span><span class="p">,</span> <span class="s2">&quot;check_lockedfiles&quot;</span><span class="p">),</span>
                     <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">toolsdir</span><span class="p">,</span> <span class="s2">&quot;getTiming&quot;</span><span class="p">),</span>
                     <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">toolsdir</span><span class="p">,</span> <span class="s2">&quot;save_provenance&quot;</span><span class="p">),</span>
                     <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">toolsdir</span><span class="p">,</span><span class="s2">&quot;Makefile&quot;</span><span class="p">),</span>
                     <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">toolsdir</span><span class="p">,</span><span class="s2">&quot;mkSrcfiles&quot;</span><span class="p">),</span>
                     <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">toolsdir</span><span class="p">,</span><span class="s2">&quot;mkDepends&quot;</span><span class="p">)]</span>

        <span class="c1"># used on Titan</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">toolsdir</span><span class="p">,</span><span class="s2">&quot;mdiag_reduce.csh&quot;</span><span class="p">)</span> <span class="p">):</span>
            <span class="n">toolfiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">toolsdir</span><span class="p">,</span><span class="s2">&quot;mdiag_reduce.csh&quot;</span><span class="p">)</span> <span class="p">)</span>
            <span class="n">toolfiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">toolsdir</span><span class="p">,</span><span class="s2">&quot;mdiag_reduce.pl&quot;</span><span class="p">)</span> <span class="p">)</span>

        <span class="k">for</span> <span class="n">toolfile</span> <span class="ow">in</span> <span class="n">toolfiles</span><span class="p">:</span>
            <span class="n">destfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">casetools</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">toolfile</span><span class="p">))</span>
            <span class="n">expect</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">toolfile</span><span class="p">),</span><span class="s2">&quot; File </span><span class="si">{}</span><span class="s2"> does not exist&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">toolfile</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">symlink</span><span class="p">(</span><span class="n">toolfile</span><span class="p">,</span> <span class="n">destfile</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;FAILED to set up toolfiles: </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">toolfile</span><span class="p">,</span> <span class="n">destfile</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">get_model</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;e3sm&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">machines_dir</span><span class="p">,</span> <span class="s2">&quot;syslog.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">machine</span><span class="p">))):</span>
                <span class="n">safe_copy</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">machines_dir</span><span class="p">,</span> <span class="s2">&quot;syslog.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">machine</span><span class="p">)),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">casetools</span><span class="p">,</span> <span class="s2">&quot;mach_syslog&quot;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">safe_copy</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">machines_dir</span><span class="p">,</span> <span class="s2">&quot;syslog.noop&quot;</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">casetools</span><span class="p">,</span> <span class="s2">&quot;mach_syslog&quot;</span><span class="p">))</span>

        <span class="c1"># add archive_metadata to the CASEROOT but only for CESM</span>
        <span class="k">if</span> <span class="n">get_model</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;cesm&quot;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">exefile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">toolsdir</span><span class="p">,</span> <span class="s2">&quot;archive_metadata&quot;</span><span class="p">)</span>
                <span class="n">destfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_caseroot</span><span class="p">,</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">exefile</span><span class="p">))</span>
                <span class="n">os</span><span class="o">.</span><span class="n">symlink</span><span class="p">(</span><span class="n">exefile</span><span class="p">,</span> <span class="n">destfile</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;FAILED to set up exefiles: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>


    <span class="k">def</span> <span class="nf">_create_caseroot_sourcemods</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">components</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_compset_components</span><span class="p">()</span>
        <span class="n">components</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s1">&#39;share&#39;</span><span class="p">,</span> <span class="s1">&#39;drv&#39;</span><span class="p">])</span>
        <span class="n">readme_message</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;Put source mods for the </span><span class="si">{component}</span><span class="s2"> library in this directory.</span>

<span class="s2">WARNING: SourceMods are not kept under version control, and can easily</span>
<span class="s2">become out of date if changes are made to the source code on which they</span>
<span class="s2">are based. We only recommend using SourceMods for small, short-term</span>
<span class="s2">changes that just apply to one or two cases. For larger or longer-term</span>
<span class="s2">changes, including gradual, incremental changes towards a final</span>
<span class="s2">solution, we highly recommend making changes in the main source tree,</span>
<span class="s2">leveraging version control (git or svn).</span>
<span class="s2">&quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">component</span> <span class="ow">in</span> <span class="n">components</span><span class="p">:</span>
            <span class="n">directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_caseroot</span><span class="p">,</span><span class="s2">&quot;SourceMods&quot;</span><span class="p">,</span><span class="s2">&quot;src.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">component</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
                <span class="c1"># Besides giving some information on SourceMods, this</span>
                <span class="c1"># README file serves one other important purpose: By</span>
                <span class="c1"># putting a file inside each SourceMods subdirectory, we</span>
                <span class="c1"># prevent aggressive scrubbers from scrubbing these</span>
                <span class="c1"># directories due to being empty (which can cause builds</span>
                <span class="c1"># to fail).</span>
                <span class="n">readme_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="s2">&quot;README&quot;</span><span class="p">)</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">readme_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fd</span><span class="p">:</span>
                    <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">readme_message</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">component</span><span class="o">=</span><span class="n">component</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">get_model</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;cesm&quot;</span><span class="p">:</span>
        <span class="c1"># Note: this is CESM specific, given that we are referencing cism explitly</span>
            <span class="k">if</span> <span class="s2">&quot;cism&quot;</span> <span class="ow">in</span> <span class="n">components</span><span class="p">:</span>
                <span class="n">directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_caseroot</span><span class="p">,</span> <span class="s2">&quot;SourceMods&quot;</span><span class="p">,</span> <span class="s2">&quot;src.cism&quot;</span><span class="p">,</span> <span class="s2">&quot;source_cism&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
                    <span class="n">readme_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="s2">&quot;README&quot;</span><span class="p">)</span>
                    <span class="n">str_to_write</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;Put source mods for the source_cism library in this subdirectory.</span>
<span class="s2">This includes any files from $COMP_ROOT_DIR_GLC/source_cism. Anything</span>
<span class="s2">else (e.g., mods to source_glc or drivers) goes in the src.cism</span>
<span class="s2">directory, NOT in this subdirectory.&quot;&quot;&quot;</span>

                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">readme_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fd</span><span class="p">:</span>
                        <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">str_to_write</span><span class="p">)</span>

<div class="viewcode-block" id="Case.create_caseroot">
<a class="viewcode-back" href="../../../CIME_api/CIME.case.html#CIME.case.case.Case.create_caseroot">[docs]</a>
    <span class="k">def</span> <span class="nf">create_caseroot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clone</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_caseroot</span><span class="p">):</span>
            <span class="c1"># Make the case directory</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot; Creating Case directory </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_caseroot</span><span class="p">))</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_caseroot</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_caseroot</span><span class="p">)</span>

        <span class="c1"># Create relevant directories in $self._caseroot</span>
        <span class="k">if</span> <span class="n">clone</span><span class="p">:</span>
            <span class="n">newdirs</span> <span class="o">=</span> <span class="p">(</span><span class="n">LOCKED_DIR</span><span class="p">,</span> <span class="s2">&quot;Tools&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">newdirs</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;SourceMods&quot;</span><span class="p">,</span> <span class="n">LOCKED_DIR</span><span class="p">,</span> <span class="s2">&quot;Buildconf&quot;</span><span class="p">,</span> <span class="s2">&quot;Tools&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">newdir</span> <span class="ow">in</span> <span class="n">newdirs</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">newdir</span><span class="p">)</span>

        <span class="c1"># Open a new README.case file in $self._caseroot</span>
        <span class="n">append_status</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">),</span> <span class="s2">&quot;README.case&quot;</span><span class="p">,</span> <span class="n">caseroot</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_caseroot</span><span class="p">)</span>
        <span class="n">compset_info</span> <span class="o">=</span> <span class="s2">&quot;Compset longname is </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;COMPSET&quot;</span><span class="p">))</span>
        <span class="n">append_status</span><span class="p">(</span><span class="n">compset_info</span><span class="p">,</span>
                      <span class="s2">&quot;README.case&quot;</span><span class="p">,</span> <span class="n">caseroot</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_caseroot</span><span class="p">)</span>
        <span class="n">append_status</span><span class="p">(</span><span class="s2">&quot;Compset specification file is </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;COMPSETS_SPEC_FILE&quot;</span><span class="p">)),</span>
                      <span class="s2">&quot;README.case&quot;</span><span class="p">,</span> <span class="n">caseroot</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_caseroot</span><span class="p">)</span>
        <span class="n">append_status</span><span class="p">(</span><span class="s2">&quot;Pes     specification file is </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;PES_SPEC_FILE&quot;</span><span class="p">)),</span>
                      <span class="s2">&quot;README.case&quot;</span><span class="p">,</span> <span class="n">caseroot</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_caseroot</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;forcing&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_component_description</span><span class="p">:</span>
            <span class="n">append_status</span><span class="p">(</span><span class="s2">&quot;Forcing is </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_component_description</span><span class="p">[</span><span class="s2">&quot;forcing&quot;</span><span class="p">])</span>
                      <span class="p">,</span><span class="s2">&quot;README.case&quot;</span><span class="p">,</span> <span class="n">caseroot</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_caseroot</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">component_class</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_component_classes</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">component_class</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_component_description</span> <span class="ow">and</span> \
               <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_component_description</span><span class="p">[</span><span class="n">component_class</span><span class="p">])</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">append_status</span><span class="p">(</span><span class="s2">&quot;Component </span><span class="si">{}</span><span class="s2"> is </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">component_class</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_component_description</span><span class="p">[</span><span class="n">component_class</span><span class="p">]),</span><span class="s2">&quot;README.case&quot;</span><span class="p">,</span> <span class="n">caseroot</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_caseroot</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">component_class</span> <span class="o">==</span> <span class="s2">&quot;CPL&quot;</span><span class="p">:</span>
                <span class="n">append_status</span><span class="p">(</span><span class="s2">&quot;Using </span><span class="si">%s</span><span class="s2"> coupler instances&quot;</span> <span class="o">%</span>
                              <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;NINST_CPL&quot;</span><span class="p">)),</span>
                              <span class="s2">&quot;README.case&quot;</span><span class="p">,</span> <span class="n">caseroot</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_caseroot</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">comp_grid</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_GRID&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">component_class</span><span class="p">)</span>

            <span class="n">append_status</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> is </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">comp_grid</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="n">comp_grid</span><span class="p">)),</span>
                          <span class="s2">&quot;README.case&quot;</span><span class="p">,</span> <span class="n">caseroot</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_caseroot</span><span class="p">)</span>
            <span class="n">comp</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;COMP_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">component_class</span><span class="p">)))</span>
            <span class="n">user_mods</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_comp_user_mods</span><span class="p">(</span><span class="n">comp</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">user_mods</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">note</span> <span class="o">=</span> <span class="s2">&quot;This component includes user_mods </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">user_mods</span><span class="p">)</span>
                <span class="n">append_status</span><span class="p">(</span><span class="n">note</span><span class="p">,</span> <span class="s2">&quot;README.case&quot;</span><span class="p">,</span> <span class="n">caseroot</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_caseroot</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">note</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">clone</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_caseroot_sourcemods</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_create_caseroot_tools</span><span class="p">()</span></div>


<div class="viewcode-block" id="Case.apply_user_mods">
<a class="viewcode-back" href="../../../CIME_api/CIME.case.html#CIME.case.case.Case.apply_user_mods">[docs]</a>
    <span class="k">def</span> <span class="nf">apply_user_mods</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_mods_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        User mods can be specified on the create_newcase command line (usually when called from create test)</span>
<span class="sd">        or they can be in the compset definition, or both.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">all_user_mods</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_component_classes</span><span class="p">:</span>
            <span class="n">component</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;COMP_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">comp</span><span class="p">)))</span>
            <span class="k">if</span> <span class="n">component</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_primary_component</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">comp_user_mods</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_comp_user_mods</span><span class="p">(</span><span class="n">component</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">comp_user_mods</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">all_user_mods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comp_user_mods</span><span class="p">)</span>
        <span class="c1"># get the primary last so that it takes precidence over other components</span>
        <span class="n">comp_user_mods</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_comp_user_mods</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_primary_component</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">comp_user_mods</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">all_user_mods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comp_user_mods</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">user_mods_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">all_user_mods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">user_mods_dir</span><span class="p">)</span>

        <span class="c1"># This looping order will lead to the specified user_mods_dir taking</span>
        <span class="c1"># precedence over self._user_mods, if there are any conflicts.</span>
        <span class="k">for</span> <span class="n">user_mods</span> <span class="ow">in</span> <span class="n">all_user_mods</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">user_mods</span><span class="p">):</span>
                <span class="n">user_mods_path</span> <span class="o">=</span> <span class="n">user_mods</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">user_mods_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s1">&#39;USER_MODS_DIR&#39;</span><span class="p">)</span>
                <span class="n">user_mods_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">user_mods_path</span><span class="p">,</span> <span class="n">user_mods</span><span class="p">)</span>
            <span class="n">apply_user_mods</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_caseroot</span><span class="p">,</span> <span class="n">user_mods_path</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_get_comp_user_mods</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">component</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        For a component &#39;foo&#39;, gets the value of FOO_USER_MODS.</span>

<span class="sd">        Returns None if no value was found, or if the value is an empty string.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">comp_user_mods</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_USER_MODS&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">component</span><span class="o">.</span><span class="n">upper</span><span class="p">()))</span>
        <span class="c1">#pylint: disable=no-member</span>
        <span class="k">if</span> <span class="n">comp_user_mods</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">comp_user_mods</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span> <span class="ow">or</span> <span class="n">comp_user_mods</span><span class="o">.</span><span class="n">isspace</span><span class="p">():</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">comp_user_mods</span>

<div class="viewcode-block" id="Case.submit_jobs">
<a class="viewcode-back" href="../../../CIME_api/CIME.case.html#CIME.case.case.Case.submit_jobs">[docs]</a>
    <span class="k">def</span> <span class="nf">submit_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">no_batch</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">job</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">skip_pnl</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">prereq</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">allow_fail</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">resubmit_immediate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mail_user</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mail_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">batch_args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">dry_run</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">env_batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_env</span><span class="p">(</span><span class="s1">&#39;batch&#39;</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span>  <span class="n">env_batch</span><span class="o">.</span><span class="n">submit_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">no_batch</span><span class="o">=</span><span class="n">no_batch</span><span class="p">,</span> <span class="n">skip_pnl</span><span class="o">=</span><span class="n">skip_pnl</span><span class="p">,</span>
                                        <span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span> <span class="n">user_prereq</span><span class="o">=</span><span class="n">prereq</span><span class="p">,</span> <span class="n">allow_fail</span><span class="o">=</span><span class="n">allow_fail</span><span class="p">,</span>
                                        <span class="n">resubmit_immediate</span><span class="o">=</span><span class="n">resubmit_immediate</span><span class="p">,</span>
                                        <span class="n">mail_user</span><span class="o">=</span><span class="n">mail_user</span><span class="p">,</span> <span class="n">mail_type</span><span class="o">=</span><span class="n">mail_type</span><span class="p">,</span>
                                        <span class="n">batch_args</span><span class="o">=</span><span class="n">batch_args</span><span class="p">,</span> <span class="n">dry_run</span><span class="o">=</span><span class="n">dry_run</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="Case.get_job_info">
<a class="viewcode-back" href="../../../CIME_api/CIME.case.html#CIME.case.case.Case.get_job_info">[docs]</a>
    <span class="k">def</span> <span class="nf">get_job_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get information on batch jobs associated with this case</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">xml_job_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;JOB_IDS&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">xml_job_ids</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">job_infos</span> <span class="o">=</span> <span class="n">xml_job_ids</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="p">)</span> <span class="c1"># pylint: disable=no-member</span>
            <span class="k">for</span> <span class="n">job_info</span> <span class="ow">in</span> <span class="n">job_infos</span><span class="p">:</span>
                <span class="n">jobname</span><span class="p">,</span> <span class="n">jobid</span> <span class="o">=</span> <span class="n">job_info</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
                <span class="n">result</span><span class="p">[</span><span class="n">jobname</span><span class="p">]</span> <span class="o">=</span> <span class="n">jobid</span>

            <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="Case.report_job_status">
<a class="viewcode-back" href="../../../CIME_api/CIME.case.html#CIME.case.case.Case.report_job_status">[docs]</a>
    <span class="k">def</span> <span class="nf">report_job_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">jobmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_job_info</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">jobmap</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No job ids associated with this case. Either case.submit was not run or was run with no-batch&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">jobname</span><span class="p">,</span> <span class="n">jobid</span> <span class="ow">in</span> <span class="n">jobmap</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_env</span><span class="p">(</span><span class="s2">&quot;batch&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get_status</span><span class="p">(</span><span class="n">jobid</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">status</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">jobname</span><span class="p">,</span> <span class="n">status</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">: Unable to get status. Job may be complete already.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">jobname</span><span class="p">))</span></div>


<div class="viewcode-block" id="Case.cancel_batch_jobs">
<a class="viewcode-back" href="../../../CIME_api/CIME.case.html#CIME.case.case.Case.cancel_batch_jobs">[docs]</a>
    <span class="k">def</span> <span class="nf">cancel_batch_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jobids</span><span class="p">):</span>
        <span class="n">env_batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_env</span><span class="p">(</span><span class="s1">&#39;batch&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">jobid</span> <span class="ow">in</span> <span class="n">jobids</span><span class="p">:</span>
            <span class="n">success</span> <span class="o">=</span> <span class="n">env_batch</span><span class="o">.</span><span class="n">cancel_job</span><span class="p">(</span><span class="n">jobid</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">success</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Failed to kill </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">jobid</span><span class="p">))</span></div>


<div class="viewcode-block" id="Case.get_mpirun_cmd">
<a class="viewcode-back" href="../../../CIME_api/CIME.case.html#CIME.case.case.Case.get_mpirun_cmd">[docs]</a>
    <span class="k">def</span> <span class="nf">get_mpirun_cmd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">allow_unresolved_envvars</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">overrides</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">job</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_primary_job</span><span class="p">()</span>

        <span class="n">env_mach_specific</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_env</span><span class="p">(</span><span class="s1">&#39;mach_specific&#39;</span><span class="p">)</span>
        <span class="n">run_exe</span> <span class="o">=</span> <span class="n">env_mach_specific</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;run_exe&quot;</span><span class="p">)</span>
        <span class="n">run_misc_suffix</span> <span class="o">=</span> <span class="n">env_mach_specific</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;run_misc_suffix&quot;</span><span class="p">)</span>
        <span class="n">run_misc_suffix</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="n">run_misc_suffix</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">run_misc_suffix</span>
        <span class="n">run_suffix</span> <span class="o">=</span> <span class="n">run_exe</span> <span class="o">+</span> <span class="n">run_misc_suffix</span>

        <span class="n">mpirun_cmd_override</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;MPI_RUN_COMMAND&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mpirun_cmd_override</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;UNSET&quot;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="n">mpirun_cmd_override</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">run_exe</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">run_misc_suffix</span>

        <span class="c1"># Things that will have to be matched against mpirun element attributes</span>
        <span class="n">mpi_attribs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;compiler&quot;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;COMPILER&quot;</span><span class="p">),</span>
            <span class="s2">&quot;mpilib&quot;</span>   <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;MPILIB&quot;</span><span class="p">),</span>
            <span class="s2">&quot;threaded&quot;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_build_threaded</span><span class="p">(),</span>
            <span class="s2">&quot;queue&quot;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;JOB_QUEUE&quot;</span><span class="p">,</span> <span class="n">subgroup</span><span class="o">=</span><span class="n">job</span><span class="p">),</span>
            <span class="s2">&quot;unit_testing&quot;</span> <span class="p">:</span> <span class="kc">False</span>
            <span class="p">}</span>
        <span class="n">executable</span><span class="p">,</span> <span class="n">mpi_arg_list</span> <span class="o">=</span> <span class="n">env_mach_specific</span><span class="o">.</span><span class="n">get_mpirun</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mpi_attribs</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">overrides</span><span class="o">=</span><span class="n">overrides</span><span class="p">)</span>
        <span class="c1"># special case for aprun</span>
        <span class="k">if</span> <span class="n">executable</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s2">&quot;aprun&quot;</span> <span class="ow">in</span> <span class="n">executable</span> <span class="ow">and</span> <span class="ow">not</span> <span class="s2">&quot;theta&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;MACH&quot;</span><span class="p">):</span>
            <span class="n">aprun_args</span><span class="p">,</span> <span class="n">num_nodes</span> <span class="o">=</span> <span class="n">get_aprun_cmd_for_case</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_exe</span><span class="p">,</span> <span class="n">overrides</span><span class="o">=</span><span class="n">overrides</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">job</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;case.run&quot;</span><span class="p">,</span><span class="s2">&quot;case.test&quot;</span><span class="p">):</span>
                <span class="n">expect</span><span class="p">(</span> <span class="p">(</span><span class="n">num_nodes</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">spare_nodes</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_nodes</span><span class="p">,</span> <span class="s2">&quot;Not using optimized num nodes&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_resolved_value</span><span class="p">(</span><span class="n">executable</span> <span class="o">+</span> <span class="n">aprun_args</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">run_misc_suffix</span><span class="p">,</span> <span class="n">allow_unresolved_envvars</span><span class="o">=</span><span class="n">allow_unresolved_envvars</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">mpi_arg_string</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mpi_arg_list</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;BATCH_SYSTEM&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;cobalt&quot;</span><span class="p">:</span>
            <span class="n">mpi_arg_string</span> <span class="o">+=</span> <span class="s2">&quot; : &quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_resolved_value</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">executable</span> <span class="k">if</span> <span class="n">executable</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">mpi_arg_string</span><span class="p">,</span> <span class="n">run_suffix</span><span class="p">),</span> <span class="n">allow_unresolved_envvars</span><span class="o">=</span><span class="n">allow_unresolved_envvars</span><span class="p">)</span></div>


<div class="viewcode-block" id="Case.set_model_version">
<a class="viewcode-back" href="../../../CIME_api/CIME.case.html#CIME.case.case.Case.set_model_version">[docs]</a>
    <span class="k">def</span> <span class="nf">set_model_version</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
        <span class="n">version</span> <span class="o">=</span> <span class="s2">&quot;unknown&quot;</span>
        <span class="n">srcroot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;SRCROOT&quot;</span><span class="p">)</span>
        <span class="n">version</span> <span class="o">=</span> <span class="n">get_current_commit</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">srcroot</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="p">(</span><span class="n">model</span><span class="o">==</span><span class="s2">&quot;cesm&quot;</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="s2">&quot;MODEL_VERSION&quot;</span><span class="p">,</span> <span class="n">version</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">version</span> <span class="o">!=</span> <span class="s2">&quot;unknown&quot;</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> model version found: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">version</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;WARNING: No </span><span class="si">{}</span><span class="s2"> Model version found.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model</span><span class="p">))</span></div>


<div class="viewcode-block" id="Case.load_env">
<a class="viewcode-back" href="../../../CIME_api/CIME.case.html#CIME.case.case.Case.load_env">[docs]</a>
    <span class="k">def</span> <span class="nf">load_env</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reset</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">job</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_env_loaded</span> <span class="ow">or</span> <span class="n">reset</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">job</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_primary_job</span><span class="p">()</span>
            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;OMP_NUM_THREADS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">thread_count</span><span class="p">)</span>
            <span class="n">env_module</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_env</span><span class="p">(</span><span class="s2">&quot;mach_specific&quot;</span><span class="p">)</span>
            <span class="n">env_module</span><span class="o">.</span><span class="n">load_env</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_is_env_loaded</span> <span class="o">=</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="Case.get_build_threaded">
<a class="viewcode-back" href="../../../CIME_api/CIME.case.html#CIME.case.case.Case.get_build_threaded">[docs]</a>
    <span class="k">def</span> <span class="nf">get_build_threaded</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns True if current settings require a threaded build/run.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">force_threaded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;FORCE_BUILD_SMP&quot;</span><span class="p">)</span>
        <span class="n">smp_present</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">force_threaded</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">thread_count</span> <span class="o">&gt;</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">smp_present</span></div>


    <span class="k">def</span> <span class="nf">_check_testlists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">compset_alias</span><span class="p">,</span> <span class="n">grid_name</span><span class="p">,</span> <span class="n">files</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        CESM only: check the testlist file for tests of this compset grid combination</span>

<span class="sd">        compset_alias should be None for a user-defined compset (i.e., a compset</span>
<span class="sd">        without an alias)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;TESTS_SPEC_FILE&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookups</span><span class="p">:</span>
            <span class="n">tests_spec_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_resolved_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lookups</span><span class="p">[</span><span class="s2">&quot;TESTS_SPEC_FILE&quot;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tests_spec_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;TESTS_SPEC_FILE&quot;</span><span class="p">)</span>

        <span class="n">testcnt</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">compset_alias</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># It&#39;s important that we not try to find matching tests if</span>
            <span class="c1"># compset_alias is None, since compset=None tells get_tests to find</span>
            <span class="c1"># tests of all compsets!</span>
            <span class="c1"># Only collect supported tests as this _check_testlists is only</span>
            <span class="c1">#   called if run_unsupported is False.</span>
            <span class="n">tests</span> <span class="o">=</span> <span class="n">Testlist</span><span class="p">(</span><span class="n">tests_spec_file</span><span class="p">,</span> <span class="n">files</span><span class="p">)</span>
            <span class="n">testlist</span> <span class="o">=</span> <span class="n">tests</span><span class="o">.</span><span class="n">get_tests</span><span class="p">(</span><span class="n">compset</span><span class="o">=</span><span class="n">compset_alias</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="n">grid_name</span><span class="p">,</span> <span class="n">supported_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">test_categories</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;prealpha&quot;</span><span class="p">,</span> <span class="s2">&quot;prebeta&quot;</span><span class="p">,</span> <span class="s2">&quot;test_release&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">test</span> <span class="ow">in</span> <span class="n">testlist</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">test</span><span class="p">[</span><span class="s2">&quot;category&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">test_categories</span> <span class="ow">or</span> <span class="s2">&quot;aux_&quot;</span> <span class="ow">in</span> <span class="n">test</span><span class="p">[</span><span class="s2">&quot;category&quot;</span><span class="p">]:</span>
                    <span class="n">testcnt</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">testcnt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">*********************************************************************************************************************************&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;This compset and grid combination is not scientifically supported, however it is used in </span><span class="si">{:d}</span><span class="s2"> tests.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">testcnt</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;*********************************************************************************************************************************</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">expect</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">This compset and grid combination is untested in CESM.  &quot;</span>
                   <span class="s2">&quot;Override this warning with the --run-unsupported option to create_newcase.&quot;</span><span class="p">,</span>
                   <span class="n">error_prefix</span><span class="o">=</span><span class="s2">&quot;STOP: &quot;</span><span class="p">)</span>

<div class="viewcode-block" id="Case.set_file">
<a class="viewcode-back" href="../../../CIME_api/CIME.case.html#CIME.case.case.Case.set_file">[docs]</a>
    <span class="k">def</span> <span class="nf">set_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xmlfile</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        force the case object to consider only xmlfile</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">expect</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">xmlfile</span><span class="p">),</span> <span class="s2">&quot;Could not find file </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">xmlfile</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_only_mode</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">flush</span><span class="p">(</span><span class="n">flushall</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">gfile</span> <span class="o">=</span> <span class="n">GenericXML</span><span class="p">(</span><span class="n">infile</span><span class="o">=</span><span class="n">xmlfile</span><span class="p">)</span>
        <span class="n">ftype</span> <span class="o">=</span> <span class="n">gfile</span><span class="o">.</span><span class="n">get_id</span><span class="p">()</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;setting case file to </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">xmlfile</span><span class="p">))</span>
        <span class="n">components</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;COMP_CLASSES&quot;</span><span class="p">)</span>
        <span class="n">new_env_file</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">env_file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_env_entryid_files</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">env_file</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span> <span class="o">==</span> <span class="n">ftype</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ftype</span> <span class="o">==</span> <span class="s2">&quot;env_run.xml&quot;</span><span class="p">:</span>
                    <span class="n">new_env_file</span> <span class="o">=</span> <span class="n">EnvRun</span><span class="p">(</span><span class="n">infile</span><span class="o">=</span><span class="n">xmlfile</span><span class="p">,</span> <span class="n">components</span><span class="o">=</span><span class="n">components</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">ftype</span> <span class="o">==</span> <span class="s2">&quot;env_build.xml&quot;</span><span class="p">:</span>
                    <span class="n">new_env_file</span> <span class="o">=</span> <span class="n">EnvBuild</span><span class="p">(</span><span class="n">infile</span><span class="o">=</span><span class="n">xmlfile</span><span class="p">,</span> <span class="n">components</span><span class="o">=</span><span class="n">components</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">ftype</span> <span class="o">==</span> <span class="s2">&quot;env_case.xml&quot;</span><span class="p">:</span>
                    <span class="n">new_env_file</span> <span class="o">=</span> <span class="n">EnvCase</span><span class="p">(</span><span class="n">infile</span><span class="o">=</span><span class="n">xmlfile</span><span class="p">,</span> <span class="n">components</span><span class="o">=</span><span class="n">components</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">ftype</span> <span class="o">==</span> <span class="s2">&quot;env_mach_pes.xml&quot;</span><span class="p">:</span>
                    <span class="n">new_env_file</span> <span class="o">=</span> <span class="n">EnvMachPes</span><span class="p">(</span><span class="n">infile</span><span class="o">=</span><span class="n">xmlfile</span><span class="p">,</span> <span class="n">components</span><span class="o">=</span><span class="n">components</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">ftype</span> <span class="o">==</span> <span class="s2">&quot;env_batch.xml&quot;</span><span class="p">:</span>
                    <span class="n">new_env_file</span> <span class="o">=</span> <span class="n">EnvBatch</span><span class="p">(</span><span class="n">infile</span><span class="o">=</span><span class="n">xmlfile</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">ftype</span> <span class="o">==</span> <span class="s2">&quot;env_workflow.xml&quot;</span><span class="p">:</span>
                    <span class="n">new_env_file</span> <span class="o">=</span> <span class="n">EnvWorkflow</span><span class="p">(</span><span class="n">infile</span><span class="o">=</span><span class="n">xmlfile</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">ftype</span> <span class="o">==</span> <span class="s2">&quot;env_test.xml&quot;</span><span class="p">:</span>
                    <span class="n">new_env_file</span> <span class="o">=</span> <span class="n">EnvTest</span><span class="p">(</span><span class="n">infile</span><span class="o">=</span><span class="n">xmlfile</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">new_env_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_env_entryid_files</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_env_generic_files</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_env_entryid_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_env_file</span><span class="p">)</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">new_env_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">env_file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_env_generic_files</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">env_file</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span> <span class="o">==</span> <span class="n">ftype</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">ftype</span> <span class="o">==</span> <span class="s2">&quot;env_archive.xml&quot;</span><span class="p">:</span>
                        <span class="n">new_env_file</span> <span class="o">=</span> <span class="n">EnvArchive</span><span class="p">(</span><span class="n">infile</span><span class="o">=</span><span class="n">xmlfile</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">ftype</span> <span class="o">==</span> <span class="s2">&quot;env_mach_specific.xml&quot;</span><span class="p">:</span>
                        <span class="n">new_env_file</span> <span class="o">=</span> <span class="n">EnvMachSpecific</span><span class="p">(</span><span class="n">infile</span><span class="o">=</span><span class="n">xmlfile</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">expect</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;No match found for file type </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ftype</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">new_env_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_env_entryid_files</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_env_generic_files</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_env_generic_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_env_file</span><span class="p">)</span>
                    <span class="k">break</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_env_entryid_files</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_env_generic_files</span></div>


<div class="viewcode-block" id="Case.update_env">
<a class="viewcode-back" href="../../../CIME_api/CIME.case.html#CIME.case.case.Case.update_env">[docs]</a>
    <span class="k">def</span> <span class="nf">update_env</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_object</span><span class="p">,</span> <span class="n">env_file</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Replace a case env object file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">old_object</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_env</span><span class="p">(</span><span class="n">env_file</span><span class="p">)</span>
        <span class="n">new_object</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">old_object</span><span class="o">.</span><span class="n">filename</span>
        <span class="k">if</span> <span class="n">old_object</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_env_entryid_files</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_env_entryid_files</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">old_object</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_env_entryid_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_object</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">old_object</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_env_generic_files</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_env_generic_files</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">old_object</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_env_generic_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_object</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">old_object</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_object</span><span class="p">)</span></div>


<div class="viewcode-block" id="Case.get_latest_cpl_log">
<a class="viewcode-back" href="../../../CIME_api/CIME.case.html#CIME.case.case.Case.get_latest_cpl_log">[docs]</a>
    <span class="k">def</span> <span class="nf">get_latest_cpl_log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coupler_log_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        find and return the latest cpl log file in the</span>
<span class="sd">        coupler_log_path directory</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">coupler_log_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">coupler_log_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;RUNDIR&quot;</span><span class="p">)</span>
        <span class="n">cpllog</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">cpllogs</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">coupler_log_path</span><span class="p">,</span> <span class="s1">&#39;cpl.log.*&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">cpllogs</span><span class="p">:</span>
            <span class="n">cpllog</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">cpllogs</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getctime</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">cpllog</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="Case.create">
<a class="viewcode-back" href="../../../CIME_api/CIME.case.html#CIME.case.case.Case.create">[docs]</a>
    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">casename</span><span class="p">,</span> <span class="n">srcroot</span><span class="p">,</span> <span class="n">compset_name</span><span class="p">,</span> <span class="n">grid_name</span><span class="p">,</span>
               <span class="n">user_mods_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">machine_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
               <span class="n">project</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pecount</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">compiler</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mpilib</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
               <span class="n">pesfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">gridfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
               <span class="n">multi_driver</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ninst</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">test</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
               <span class="n">walltime</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">queue</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output_root</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
               <span class="n">run_unsupported</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">answer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
               <span class="n">input_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">workflowid</span><span class="o">=</span><span class="s2">&quot;default&quot;</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Set values for env_case.xml</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_lookup_value</span><span class="p">(</span><span class="s2">&quot;CASE&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">casename</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_lookup_value</span><span class="p">(</span><span class="s2">&quot;CASEROOT&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_caseroot</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_lookup_value</span><span class="p">(</span><span class="s2">&quot;SRCROOT&quot;</span><span class="p">,</span> <span class="n">srcroot</span><span class="p">)</span>

            <span class="c1"># Configure the Case</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">compset_name</span><span class="p">,</span> <span class="n">grid_name</span><span class="p">,</span> <span class="n">machine_name</span><span class="o">=</span><span class="n">machine_name</span><span class="p">,</span>
                           <span class="n">project</span><span class="o">=</span><span class="n">project</span><span class="p">,</span>
                           <span class="n">pecount</span><span class="o">=</span><span class="n">pecount</span><span class="p">,</span> <span class="n">compiler</span><span class="o">=</span><span class="n">compiler</span><span class="p">,</span> <span class="n">mpilib</span><span class="o">=</span><span class="n">mpilib</span><span class="p">,</span>
                           <span class="n">pesfile</span><span class="o">=</span><span class="n">pesfile</span><span class="p">,</span> <span class="n">gridfile</span><span class="o">=</span><span class="n">gridfile</span><span class="p">,</span>
                           <span class="n">multi_driver</span><span class="o">=</span><span class="n">multi_driver</span><span class="p">,</span> <span class="n">ninst</span><span class="o">=</span><span class="n">ninst</span><span class="p">,</span> <span class="n">test</span><span class="o">=</span><span class="n">test</span><span class="p">,</span>
                           <span class="n">walltime</span><span class="o">=</span><span class="n">walltime</span><span class="p">,</span> <span class="n">queue</span><span class="o">=</span><span class="n">queue</span><span class="p">,</span>
                           <span class="n">output_root</span><span class="o">=</span><span class="n">output_root</span><span class="p">,</span>
                           <span class="n">run_unsupported</span><span class="o">=</span><span class="n">run_unsupported</span><span class="p">,</span> <span class="n">answer</span><span class="o">=</span><span class="n">answer</span><span class="p">,</span>
                           <span class="n">input_dir</span><span class="o">=</span><span class="n">input_dir</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="n">driver</span><span class="p">,</span> <span class="n">workflowid</span><span class="o">=</span><span class="n">workflowid</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">create_caseroot</span><span class="p">()</span>

            <span class="c1"># Write out the case files</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">flush</span><span class="p">(</span><span class="n">flushall</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">apply_user_mods</span><span class="p">(</span><span class="n">user_mods_dir</span><span class="p">)</span>

            <span class="c1"># Lock env_case.xml</span>
            <span class="n">lock_file</span><span class="p">(</span><span class="s2">&quot;env_case.xml&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_caseroot</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_caseroot</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">logger</span><span class="o">.</span><span class="n">isEnabledFor</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">test</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Failed to setup case, removing </span><span class="si">{}</span><span class="se">\n</span><span class="s2">Use --debug to force me to keep caseroot&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_caseroot</span><span class="p">))</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_caseroot</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Leaving broken case dir </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_caseroot</span><span class="p">))</span>

            <span class="k">raise</span></div>


<div class="viewcode-block" id="Case.is_save_timing_dir_project">
<a class="viewcode-back" href="../../../CIME_api/CIME.case.html#CIME.case.case.Case.is_save_timing_dir_project">[docs]</a>
    <span class="k">def</span> <span class="nf">is_save_timing_dir_project</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">project</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check whether the project is permitted to archive performance data in the location</span>
<span class="sd">        specified for the current machine</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">save_timing_dir_projects</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;SAVE_TIMING_DIR_PROJECTS&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">save_timing_dir_projects</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">save_timing_dir_projects</span> <span class="o">=</span> <span class="n">save_timing_dir_projects</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span> <span class="c1"># pylint: disable=no-member</span>
            <span class="k">for</span> <span class="n">save_timing_dir_project</span> <span class="ow">in</span> <span class="n">save_timing_dir_projects</span><span class="p">:</span>
                <span class="n">regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">save_timing_dir_project</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">regex</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">project</span><span class="p">):</span>
                    <span class="k">return</span> <span class="kc">True</span>

            <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="Case.get_primary_job">
<a class="viewcode-back" href="../../../CIME_api/CIME.case.html#CIME.case.case.Case.get_primary_job">[docs]</a>
    <span class="k">def</span> <span class="nf">get_primary_job</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;case.test&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;TEST&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;case.run&quot;</span></div>


<div class="viewcode-block" id="Case.get_first_job">
<a class="viewcode-back" href="../../../CIME_api/CIME.case.html#CIME.case.case.Case.get_first_job">[docs]</a>
    <span class="k">def</span> <span class="nf">get_first_job</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">env_workflow</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_env</span><span class="p">(</span><span class="s2">&quot;workflow&quot;</span><span class="p">)</span>
        <span class="n">jobs</span> <span class="o">=</span> <span class="n">env_workflow</span><span class="o">.</span><span class="n">get_jobs</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">jobs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2017, U.S. National Science Foundation and U.S. Department of Energy.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
  
     
<script>var version_json_loc = "../../../../../versions.json";</script>


</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>