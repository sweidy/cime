<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CIME.SystemTests.system_tests_common &mdash; CIME with documentation about the Replay cime5.6.replay documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../_static/documentation_options.js?v=5d88beb4"></script>
        <script src="../../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="../../../_static/pop_ver.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            CIME with documentation about the Replay
          </a>
              <div class="version">
                cime5.6.replay
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../what_cime/index.html">What is CIME?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../users_guide/index.html">Case Control System Part 1: Basic Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../users_guide/index.html#case-control-system-part-2-configuration-porting-testing-and-use-cases">Case Control System Part 2: Configuration, Porting, Testing and Use Cases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../data_models/index.html">Data Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../driver_cpl/index.html">Driver/Coupler</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../build_cpl/index.html">Building a Coupled Model with CIME</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../misc_tools/index.html">Miscellaneous Tools</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../glossary/index.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Tools_user/index.html">User Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../xml_files/index.html">XML Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../CIME_api/modules.html">CIME</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Tools_api/modules.html">Tools</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">CIME with documentation about the Replay</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">CIME.SystemTests.system_tests_common</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for CIME.SystemTests.system_tests_common</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Base class for CIME system tests</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">CIME.XML.standard_module_setup</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">CIME.XML.env_run</span> <span class="kn">import</span> <span class="n">EnvRun</span>
<span class="kn">from</span> <span class="nn">CIME.utils</span> <span class="kn">import</span> <span class="n">append_testlog</span><span class="p">,</span> <span class="n">get_model</span><span class="p">,</span> <span class="n">safe_copy</span>
<span class="kn">from</span> <span class="nn">CIME.test_status</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">CIME.hist_utils</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">CIME.provenance</span> <span class="kn">import</span> <span class="n">save_test_time</span>
<span class="kn">from</span> <span class="nn">CIME.locked_files</span> <span class="kn">import</span> <span class="n">LOCKED_DIR</span><span class="p">,</span> <span class="n">lock_file</span><span class="p">,</span> <span class="n">is_locked</span>
<span class="kn">import</span> <span class="nn">CIME.build</span> <span class="k">as</span> <span class="nn">build</span>

<span class="kn">import</span> <span class="nn">glob</span><span class="o">,</span> <span class="nn">gzip</span><span class="o">,</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">traceback</span><span class="o">,</span> <span class="nn">six</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<div class="viewcode-block" id="SystemTestsCommon">
<a class="viewcode-back" href="../../../CIME_api/CIME.SystemTests.html#CIME.SystemTests.system_tests_common.SystemTestsCommon">[docs]</a>
<span class="k">class</span> <span class="nc">SystemTestsCommon</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">case</span><span class="p">,</span> <span class="n">expected</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        initialize a CIME system test object, if the locked env_run.orig.xml</span>
<span class="sd">        does not exist copy the current env_run.xml file.  If it does exist restore values</span>
<span class="sd">        changed in a previous run of the test.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_case</span> <span class="o">=</span> <span class="n">case</span>
        <span class="n">caseroot</span> <span class="o">=</span> <span class="n">case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;CASEROOT&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_caseroot</span> <span class="o">=</span> <span class="n">caseroot</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_orig_caseroot</span> <span class="o">=</span> <span class="n">caseroot</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_runstatus</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_casebaseid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;CASEBASEID&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_test_status</span> <span class="o">=</span> <span class="n">TestStatus</span><span class="p">(</span><span class="n">test_dir</span><span class="o">=</span><span class="n">caseroot</span><span class="p">,</span> <span class="n">test_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_casebaseid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_environment</span><span class="p">(</span><span class="n">caseroot</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_locked_files</span><span class="p">(</span><span class="n">caseroot</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_skip_pnl</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cpllog</span> <span class="o">=</span> <span class="s1">&#39;cpl&#39;</span>

    <span class="k">def</span> <span class="nf">_init_environment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">caseroot</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Do initializations of environment variables that are needed in __init__</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Needed for sh scripts</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;CASEROOT&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">caseroot</span>

    <span class="k">def</span> <span class="nf">_init_locked_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">caseroot</span><span class="p">,</span> <span class="n">expected</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        If the locked env_run.orig.xml does not exist, copy the current</span>
<span class="sd">        env_run.xml file. If it does exist, restore values changed in a previous</span>
<span class="sd">        run of the test.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">is_locked</span><span class="p">(</span><span class="s2">&quot;env_run.orig.xml&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compare_env_run</span><span class="p">(</span><span class="n">expected</span><span class="o">=</span><span class="n">expected</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">caseroot</span><span class="p">,</span> <span class="s2">&quot;env_run.xml&quot;</span><span class="p">)):</span>
            <span class="n">lock_file</span><span class="p">(</span><span class="s2">&quot;env_run.xml&quot;</span><span class="p">,</span> <span class="n">caseroot</span><span class="o">=</span><span class="n">caseroot</span><span class="p">,</span> <span class="n">newname</span><span class="o">=</span><span class="s2">&quot;env_run.orig.xml&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_resetup_case</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phase</span><span class="p">,</span> <span class="n">reset</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Re-setup this case. This is necessary if user is re-running an already-run</span>
<span class="sd">        phase.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># We never want to re-setup if we&#39;re doing the resubmitted run</span>
        <span class="n">phase_status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_test_status</span><span class="o">.</span><span class="n">get_status</span><span class="p">(</span><span class="n">phase</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">reset</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;IS_FIRST_RUN&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">phase_status</span> <span class="o">!=</span> <span class="n">TEST_PEND_STATUS</span><span class="p">):</span>

            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Resetting case due to detected re-run of phase </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">phase</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">set_initial_test_values</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">case_setup</span><span class="p">(</span><span class="n">reset</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">test_mode</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<div class="viewcode-block" id="SystemTestsCommon.build">
<a class="viewcode-back" href="../../../CIME_api/CIME.SystemTests.html#CIME.SystemTests.system_tests_common.SystemTestsCommon.build">[docs]</a>
    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sharedlib_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">model_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Do NOT override this method, this method is the framework that</span>
<span class="sd">        controls the build phase. build_phase is the extension point</span>
<span class="sd">        that subclasses should use.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">success</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">phase_name</span><span class="p">,</span> <span class="n">phase_bool</span> <span class="ow">in</span> <span class="p">[(</span><span class="n">SHAREDLIB_BUILD_PHASE</span><span class="p">,</span> <span class="ow">not</span> <span class="n">model_only</span><span class="p">),</span>
                                       <span class="p">(</span><span class="n">MODEL_BUILD_PHASE</span><span class="p">,</span> <span class="ow">not</span> <span class="n">sharedlib_only</span><span class="p">)]:</span>
            <span class="k">if</span> <span class="n">phase_bool</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_resetup_case</span><span class="p">(</span><span class="n">phase_name</span><span class="p">)</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_test_status</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_test_status</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="n">phase_name</span><span class="p">,</span> <span class="n">TEST_PEND_STATUS</span><span class="p">)</span>

                <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">build_phase</span><span class="p">(</span><span class="n">sharedlib_only</span><span class="o">=</span><span class="p">(</span><span class="n">phase_name</span><span class="o">==</span><span class="n">SHAREDLIB_BUILD_PHASE</span><span class="p">),</span>
                                     <span class="n">model_only</span><span class="o">=</span><span class="p">(</span><span class="n">phase_name</span><span class="o">==</span><span class="n">MODEL_BUILD_PHASE</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="fm">__str__</span><span class="p">()</span>
                    <span class="k">if</span> <span class="s2">&quot;FAILED, cat&quot;</span> <span class="ow">in</span> <span class="n">msg</span> <span class="ow">or</span> <span class="s2">&quot;BUILD FAIL&quot;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">:</span>
                        <span class="c1"># Don&#39;t want to print stacktrace for a build failure since that</span>
                        <span class="c1"># is not a CIME/infrastructure problem.</span>
                        <span class="n">excmsg</span> <span class="o">=</span> <span class="n">msg</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">excmsg</span> <span class="o">=</span> <span class="s2">&quot;Exception during build:</span><span class="se">\n</span><span class="si">{}</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>

                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">excmsg</span><span class="p">)</span>
                    <span class="n">append_testlog</span><span class="p">(</span><span class="n">excmsg</span><span class="p">)</span>

                <span class="n">time_taken</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_test_status</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_test_status</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="n">phase_name</span><span class="p">,</span> <span class="n">TEST_PASS_STATUS</span> <span class="k">if</span> <span class="n">success</span> <span class="k">else</span> <span class="n">TEST_FAIL_STATUS</span><span class="p">,</span> <span class="n">comments</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;time=</span><span class="si">{:d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">time_taken</span><span class="p">))))</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">success</span><span class="p">:</span>
                    <span class="k">break</span>

        <span class="k">return</span> <span class="n">success</span></div>


<div class="viewcode-block" id="SystemTestsCommon.build_phase">
<a class="viewcode-back" href="../../../CIME_api/CIME.SystemTests.html#CIME.SystemTests.system_tests_common.SystemTestsCommon.build_phase">[docs]</a>
    <span class="k">def</span> <span class="nf">build_phase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sharedlib_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">model_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is the default build phase implementation, it just does an individual build.</span>
<span class="sd">        This is the subclass&#39; extension point if they need to define a custom build</span>
<span class="sd">        phase.</span>

<span class="sd">        PLEASE THROW EXCEPTION ON FAIL</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build_indv</span><span class="p">(</span><span class="n">sharedlib_only</span><span class="o">=</span><span class="n">sharedlib_only</span><span class="p">,</span> <span class="n">model_only</span><span class="o">=</span><span class="n">model_only</span><span class="p">)</span></div>


<div class="viewcode-block" id="SystemTestsCommon.build_indv">
<a class="viewcode-back" href="../../../CIME_api/CIME.SystemTests.html#CIME.SystemTests.system_tests_common.SystemTestsCommon.build_indv">[docs]</a>
    <span class="k">def</span> <span class="nf">build_indv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sharedlib_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">model_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform an individual build</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s1">&#39;MODEL&#39;</span><span class="p">)</span>
        <span class="n">build</span><span class="o">.</span><span class="n">case_build</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_caseroot</span><span class="p">,</span> <span class="n">case</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="p">,</span>
                         <span class="n">sharedlib_only</span><span class="o">=</span><span class="n">sharedlib_only</span><span class="p">,</span> <span class="n">model_only</span><span class="o">=</span><span class="n">model_only</span><span class="p">,</span>
                         <span class="n">save_build_provenance</span><span class="o">=</span><span class="ow">not</span> <span class="n">model</span><span class="o">==</span><span class="s1">&#39;cesm&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="SystemTestsCommon.clean_build">
<a class="viewcode-back" href="../../../CIME_api/CIME.SystemTests.html#CIME.SystemTests.system_tests_common.SystemTestsCommon.clean_build">[docs]</a>
    <span class="k">def</span> <span class="nf">clean_build</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">comps</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">comps</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">comps</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_values</span><span class="p">(</span><span class="s2">&quot;COMP_CLASSES&quot;</span><span class="p">)]</span>
        <span class="n">build</span><span class="o">.</span><span class="n">clean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="p">,</span> <span class="n">cleanlist</span><span class="o">=</span><span class="n">comps</span><span class="p">)</span></div>


<div class="viewcode-block" id="SystemTestsCommon.run">
<a class="viewcode-back" href="../../../CIME_api/CIME.SystemTests.html#CIME.SystemTests.system_tests_common.SystemTestsCommon.run">[docs]</a>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">skip_pnl</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Do NOT override this method, this method is the framework that controls</span>
<span class="sd">        the run phase. run_phase is the extension point that subclasses should use.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">success</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_skip_pnl</span> <span class="o">=</span> <span class="n">skip_pnl</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_resetup_case</span><span class="p">(</span><span class="n">RUN_PHASE</span><span class="p">)</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_test_status</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_test_status</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="n">RUN_PHASE</span><span class="p">,</span> <span class="n">TEST_PEND_STATUS</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">run_phase</span><span class="p">()</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;GENERATE_BASELINE&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_generate_baseline</span><span class="p">()</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;COMPARE_BASELINE&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_compare_baseline</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_check_for_memleak</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_st_archive_case_test</span><span class="p">()</span>


        <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="fm">__str__</span><span class="p">()</span>
            <span class="k">if</span> <span class="s2">&quot;RUN FAIL&quot;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">:</span>
                <span class="c1"># Don&#39;t want to print stacktrace for a model failure since that</span>
                <span class="c1"># is not a CIME/infrastructure problem.</span>
                <span class="n">excmsg</span> <span class="o">=</span> <span class="n">msg</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">excmsg</span> <span class="o">=</span> <span class="s2">&quot;Exception during run:</span><span class="se">\n</span><span class="si">{}</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">excmsg</span><span class="p">)</span>
            <span class="n">append_testlog</span><span class="p">(</span><span class="n">excmsg</span><span class="p">)</span>

        <span class="c1"># Writing the run status should be the very last thing due to wait_for_tests</span>
        <span class="n">time_taken</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">TEST_PASS_STATUS</span> <span class="k">if</span> <span class="n">success</span> <span class="k">else</span> <span class="n">TEST_FAIL_STATUS</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_test_status</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_test_status</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="n">RUN_PHASE</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">comments</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;time=</span><span class="si">{:d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">time_taken</span><span class="p">))))</span>

        <span class="k">if</span> <span class="n">success</span> <span class="ow">and</span> <span class="n">get_model</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;e3sm&quot;</span><span class="p">:</span>
            <span class="n">save_test_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;BASELINE_ROOT&quot;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_casebaseid</span><span class="p">,</span> <span class="n">time_taken</span><span class="p">)</span>

        <span class="c1"># We return success if the run phase worked; memleaks, diffs will not be taken into account</span>
        <span class="c1"># with this return value.</span>
        <span class="k">return</span> <span class="n">success</span></div>


<div class="viewcode-block" id="SystemTestsCommon.run_phase">
<a class="viewcode-back" href="../../../CIME_api/CIME.SystemTests.html#CIME.SystemTests.system_tests_common.SystemTestsCommon.run_phase">[docs]</a>
    <span class="k">def</span> <span class="nf">run_phase</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is the default run phase implementation, it just does an individual run.</span>
<span class="sd">        This is the subclass&#39; extension point if they need to define a custom run phase.</span>

<span class="sd">        PLEASE THROW AN EXCEPTION ON FAIL</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_indv</span><span class="p">()</span></div>


    <span class="k">def</span> <span class="nf">_get_caseroot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the current CASEROOT value</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_caseroot</span>

    <span class="k">def</span> <span class="nf">_set_active_case</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">case</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Use for tests that have multiple cases</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_case</span> <span class="o">=</span> <span class="n">case</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">load_env</span><span class="p">(</span><span class="n">reset</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_caseroot</span> <span class="o">=</span> <span class="n">case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;CASEROOT&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="SystemTestsCommon.run_indv">
<a class="viewcode-back" href="../../../CIME_api/CIME.SystemTests.html#CIME.SystemTests.system_tests_common.SystemTestsCommon.run_indv">[docs]</a>
    <span class="k">def</span> <span class="nf">run_indv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;base&quot;</span><span class="p">,</span> <span class="n">st_archive</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform an individual run. Raises an EXCEPTION on fail.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">stop_n</span>      <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;STOP_N&quot;</span><span class="p">)</span>
        <span class="n">stop_option</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;STOP_OPTION&quot;</span><span class="p">)</span>
        <span class="n">run_type</span>    <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;RUN_TYPE&quot;</span><span class="p">)</span>
        <span class="n">rundir</span>      <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;RUNDIR&quot;</span><span class="p">)</span>
        <span class="c1"># remove any cprnc output leftover from previous runs</span>
        <span class="k">for</span> <span class="n">compout</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">iglob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rundir</span><span class="p">,</span><span class="s2">&quot;*.cprnc.out&quot;</span><span class="p">)):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">compout</span><span class="p">)</span>

        <span class="n">infostr</span>     <span class="o">=</span> <span class="s2">&quot;doing an </span><span class="si">{:d}</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> test&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">stop_n</span><span class="p">,</span> <span class="n">stop_option</span><span class="p">,</span> <span class="n">run_type</span><span class="p">)</span>

        <span class="n">rest_option</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;REST_OPTION&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rest_option</span> <span class="o">==</span> <span class="s2">&quot;none&quot;</span> <span class="ow">or</span> <span class="n">rest_option</span> <span class="o">==</span> <span class="s2">&quot;never&quot;</span><span class="p">:</span>
            <span class="n">infostr</span> <span class="o">+=</span> <span class="s2">&quot;, no restarts written&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rest_n</span>   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;REST_N&quot;</span><span class="p">)</span>
            <span class="n">infostr</span> <span class="o">+=</span> <span class="s2">&quot;, with restarts every </span><span class="si">{:d}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rest_n</span><span class="p">,</span> <span class="n">rest_option</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">infostr</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">case_run</span><span class="p">(</span><span class="n">skip_pnl</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_skip_pnl</span><span class="p">,</span> <span class="n">submit_resubmits</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coupler_log_indicates_run_complete</span><span class="p">():</span>
            <span class="n">expect</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;Coupler did not indicate run passed&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">suffix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_component_compare_copy</span><span class="p">(</span><span class="n">suffix</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">st_archive</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">case_st_archive</span><span class="p">(</span><span class="n">resubmit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_coupler_log_indicates_run_complete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">newestcpllogfiles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_latest_cpl_logs</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Latest Coupler log file(s) </span><span class="si">{}</span><span class="s2">&quot;</span> <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">newestcpllogfiles</span><span class="p">))</span>
        <span class="c1"># Exception is raised if the file is not compressed</span>
        <span class="n">allgood</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">newestcpllogfiles</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">cpllog</span> <span class="ow">in</span> <span class="n">newestcpllogfiles</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">six</span><span class="o">.</span><span class="n">b</span><span class="p">(</span><span class="s2">&quot;SUCCESSFUL TERMINATION&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">cpllog</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">():</span>
                    <span class="n">allgood</span> <span class="o">=</span> <span class="n">allgood</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="fm">__str__</span><span class="p">()</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> is not compressed, assuming run failed </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cpllog</span><span class="p">,</span> <span class="n">msg</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">allgood</span><span class="o">==</span><span class="mi">0</span>

    <span class="k">def</span> <span class="nf">_component_compare_copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">suffix</span><span class="p">):</span>
        <span class="n">comments</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="p">,</span> <span class="n">suffix</span><span class="p">)</span>
        <span class="n">append_testlog</span><span class="p">(</span><span class="n">comments</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_component_compare_test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">suffix1</span><span class="p">,</span> <span class="n">suffix2</span><span class="p">,</span> <span class="n">success_change</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return value is not generally checked, but is provided in case a custom</span>
<span class="sd">        run case needs indirection based on success.</span>
<span class="sd">        If success_change is True, success requires some files to be different</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">success</span><span class="p">,</span> <span class="n">comments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_do_compare_test</span><span class="p">(</span><span class="n">suffix1</span><span class="p">,</span> <span class="n">suffix2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">success_change</span><span class="p">:</span>
            <span class="n">success</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">success</span>

        <span class="n">append_testlog</span><span class="p">(</span><span class="n">comments</span><span class="p">)</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">TEST_PASS_STATUS</span> <span class="k">if</span> <span class="n">success</span> <span class="k">else</span> <span class="n">TEST_FAIL_STATUS</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_test_status</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_test_status</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">COMPARE_PHASE</span><span class="p">,</span> <span class="n">suffix1</span><span class="p">,</span> <span class="n">suffix2</span><span class="p">),</span> <span class="n">status</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">success</span>

    <span class="k">def</span> <span class="nf">_do_compare_test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">suffix1</span><span class="p">,</span> <span class="n">suffix2</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Wraps the call to compare_test to facilitate replacement in unit</span>
<span class="sd">        tests</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">compare_test</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="p">,</span> <span class="n">suffix1</span><span class="p">,</span> <span class="n">suffix2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_st_archive_case_test</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">test_env_archive</span><span class="p">()</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_test_status</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_test_status</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="n">STARCHIVE_PHASE</span><span class="p">,</span> <span class="n">TEST_PASS_STATUS</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_test_status</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="n">STARCHIVE_PHASE</span><span class="p">,</span> <span class="n">TEST_FAIL_STATUS</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">_get_mem_usage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cpllog</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Examine memory usage as recorded in the cpl log file and look for unexpected</span>
<span class="sd">        increases.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">memlist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">meminfo</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;.*model date =\s+(\w+).*memory =\s+(\d+\.?\d+).*highwater&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cpllog</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">cpllog</span><span class="p">):</span>
            <span class="k">if</span> <span class="s1">&#39;.gz&#39;</span> <span class="o">==</span> <span class="n">cpllog</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]:</span>
                <span class="n">fopen</span> <span class="o">=</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fopen</span> <span class="o">=</span> <span class="nb">open</span>
            <span class="k">with</span> <span class="n">fopen</span><span class="p">(</span><span class="n">cpllog</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">m</span> <span class="o">=</span> <span class="n">meminfo</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
                        <span class="n">memlist</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="nb">float</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span> <span class="nb">float</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">))))</span>
        <span class="c1"># Remove the last mem record, it&#39;s sometimes artificially high</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">memlist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">memlist</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">memlist</span>

    <span class="k">def</span> <span class="nf">_get_throughput</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cpllog</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Examine memory usage as recorded in the cpl log file and look for unexpected</span>
<span class="sd">        increases.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">cpllog</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">cpllog</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">cpllog</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">cpltext</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
                <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;# simulated years / cmp-day =\s+(\d+\.\d+)\s&quot;</span><span class="p">,</span><span class="n">cpltext</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
                    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_check_for_memleak</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Examine memory usage as recorded in the cpl log file and look for unexpected</span>
<span class="sd">        increases.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">latestcpllogs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_latest_cpl_logs</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">cpllog</span> <span class="ow">in</span> <span class="n">latestcpllogs</span><span class="p">:</span>
            <span class="n">memlist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_mem_usage</span><span class="p">(</span><span class="n">cpllog</span><span class="p">)</span>

            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_test_status</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">memlist</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_test_status</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="n">MEMLEAK_PHASE</span><span class="p">,</span> <span class="n">TEST_PASS_STATUS</span><span class="p">,</span> <span class="n">comments</span><span class="o">=</span><span class="s2">&quot;insuffiencient data for memleak test&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">finaldate</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">memlist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">originaldate</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">memlist</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">finalmem</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">memlist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">originalmem</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">memlist</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">memdiff</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="k">if</span> <span class="n">originalmem</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">memdiff</span> <span class="o">=</span> <span class="p">(</span><span class="n">finalmem</span> <span class="o">-</span> <span class="n">originalmem</span><span class="p">)</span><span class="o">/</span><span class="n">originalmem</span>
                    <span class="n">tolerance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;TEST_MEMLEAK_TOLERANCE&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">tolerance</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">tolerance</span> <span class="o">=</span> <span class="mf">0.1</span>
                    <span class="n">expect</span><span class="p">(</span><span class="n">tolerance</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s2">&quot;Bad value for memleak tolerance in test&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">memdiff</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_test_status</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="n">MEMLEAK_PHASE</span><span class="p">,</span> <span class="n">TEST_PASS_STATUS</span><span class="p">,</span> <span class="n">comments</span><span class="o">=</span><span class="s2">&quot;insuffiencient data for memleak test&quot;</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">memdiff</span> <span class="o">&lt;</span> <span class="n">tolerance</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_test_status</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="n">MEMLEAK_PHASE</span><span class="p">,</span> <span class="n">TEST_PASS_STATUS</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">comment</span> <span class="o">=</span> <span class="s2">&quot;memleak detected, memory went from </span><span class="si">{:f}</span><span class="s2"> to </span><span class="si">{:f}</span><span class="s2"> in </span><span class="si">{:d}</span><span class="s2"> days&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">originalmem</span><span class="p">,</span> <span class="n">finalmem</span><span class="p">,</span> <span class="n">finaldate</span><span class="o">-</span><span class="n">originaldate</span><span class="p">)</span>
                        <span class="n">append_testlog</span><span class="p">(</span><span class="n">comment</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_test_status</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="n">MEMLEAK_PHASE</span><span class="p">,</span> <span class="n">TEST_FAIL_STATUS</span><span class="p">,</span> <span class="n">comments</span><span class="o">=</span><span class="n">comment</span><span class="p">)</span>

<div class="viewcode-block" id="SystemTestsCommon.compare_env_run">
<a class="viewcode-back" href="../../../CIME_api/CIME.SystemTests.html#CIME.SystemTests.system_tests_common.SystemTestsCommon.compare_env_run">[docs]</a>
    <span class="k">def</span> <span class="nf">compare_env_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expected</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compare env_run file to original and warn about differences</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">components</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_values</span><span class="p">(</span><span class="s2">&quot;COMP_CLASSES&quot;</span><span class="p">)</span>
        <span class="n">f1obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_env</span><span class="p">(</span><span class="s2">&quot;run&quot;</span><span class="p">)</span>
        <span class="n">f2obj</span> <span class="o">=</span> <span class="n">EnvRun</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_caseroot</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">LOCKED_DIR</span><span class="p">,</span> <span class="s2">&quot;env_run.orig.xml&quot;</span><span class="p">),</span> <span class="n">components</span><span class="o">=</span><span class="n">components</span><span class="p">)</span>
        <span class="n">diffs</span> <span class="o">=</span> <span class="n">f1obj</span><span class="o">.</span><span class="n">compare_xml</span><span class="p">(</span><span class="n">f2obj</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">diffs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">expected</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">expected</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;  Resetting </span><span class="si">{}</span><span class="s2"> for test&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
                <span class="n">f1obj</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">f2obj</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">resolved</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WARNING: Found difference in test </span><span class="si">{}</span><span class="s2">: case: </span><span class="si">{}</span><span class="s2"> original value </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">diffs</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">diffs</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span></div>


    <span class="k">def</span> <span class="nf">_get_latest_cpl_logs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        find and return the latest cpl log file in the run directory</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">coupler_log_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;RUNDIR&quot;</span><span class="p">)</span>
        <span class="n">cpllogs</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">coupler_log_path</span><span class="p">,</span> <span class="s1">&#39;cpl*.log.*&#39;</span><span class="p">))</span>
        <span class="n">lastcpllogs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">cpllogs</span><span class="p">:</span>
            <span class="n">lastcpllogs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">cpllogs</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getctime</span><span class="p">))</span>
            <span class="n">basename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">lastcpllogs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">suffix</span> <span class="o">=</span> <span class="n">basename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">log</span> <span class="ow">in</span> <span class="n">cpllogs</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">log</span> <span class="ow">in</span> <span class="n">lastcpllogs</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="n">log</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">suffix</span><span class="p">):</span>
                    <span class="n">lastcpllogs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">log</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">lastcpllogs</span>

    <span class="k">def</span> <span class="nf">_compare_baseline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        compare the current test output to a baseline result</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_test_status</span><span class="p">:</span>
            <span class="c1"># compare baseline</span>
            <span class="n">success</span><span class="p">,</span> <span class="n">comments</span> <span class="o">=</span> <span class="n">compare_baseline</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="p">)</span>
            <span class="n">append_testlog</span><span class="p">(</span><span class="n">comments</span><span class="p">)</span>
            <span class="n">status</span> <span class="o">=</span> <span class="n">TEST_PASS_STATUS</span> <span class="k">if</span> <span class="n">success</span> <span class="k">else</span> <span class="n">TEST_FAIL_STATUS</span>
            <span class="n">baseline_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;BASECMP_CASE&quot;</span><span class="p">)</span>
            <span class="n">ts_comments</span> <span class="o">=</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">baseline_name</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;: &quot;</span> <span class="o">+</span> <span class="n">comments</span><span class="p">)</span> <span class="k">if</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">comments</span> <span class="k">else</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">baseline_name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_test_status</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="n">BASELINE_PHASE</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">comments</span><span class="o">=</span><span class="n">ts_comments</span><span class="p">)</span>
            <span class="n">basecmp_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;BASELINE_ROOT&quot;</span><span class="p">),</span> <span class="n">baseline_name</span><span class="p">)</span>

            <span class="c1"># compare memory usage to baseline</span>
            <span class="n">newestcpllogfiles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_latest_cpl_logs</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">newestcpllogfiles</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">memlist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_mem_usage</span><span class="p">(</span><span class="n">newestcpllogfiles</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">cpllog</span> <span class="ow">in</span> <span class="n">newestcpllogfiles</span><span class="p">:</span>
                <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;/(cpl.*.log).*.gz&quot;</span><span class="p">,</span><span class="n">cpllog</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">m</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">baselog</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">basecmp_dir</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">+</span><span class="s2">&quot;.gz&quot;</span>
                <span class="k">if</span> <span class="n">baselog</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">baselog</span><span class="p">):</span>
                    <span class="c1"># for backward compatibility</span>
                    <span class="n">baselog</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">basecmp_dir</span><span class="p">,</span> <span class="s2">&quot;cpl.log&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">baselog</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">memlist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="n">blmem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_mem_usage</span><span class="p">(</span><span class="n">baselog</span><span class="p">)</span>
                    <span class="n">blmem</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">blmem</span> <span class="o">==</span> <span class="p">[]</span> <span class="k">else</span> <span class="n">blmem</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">curmem</span> <span class="o">=</span> <span class="n">memlist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">diff</span> <span class="o">=</span> <span class="p">(</span><span class="n">curmem</span><span class="o">-</span><span class="n">blmem</span><span class="p">)</span><span class="o">/</span><span class="n">blmem</span>
                    <span class="k">if</span> <span class="n">diff</span> <span class="o">&lt;</span> <span class="mf">0.1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_test_status</span><span class="o">.</span><span class="n">get_status</span><span class="p">(</span><span class="n">MEMCOMP_PHASE</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_test_status</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="n">MEMCOMP_PHASE</span><span class="p">,</span> <span class="n">TEST_PASS_STATUS</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_test_status</span><span class="o">.</span><span class="n">get_status</span><span class="p">(</span><span class="n">MEMCOMP_PHASE</span><span class="p">)</span> <span class="o">!=</span> <span class="n">TEST_FAIL_STATUS</span><span class="p">:</span>
                        <span class="n">comment</span> <span class="o">=</span> <span class="s2">&quot;Error: Memory usage increase &gt; 10</span><span class="si">% f</span><span class="s2">rom baseline&quot;</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_test_status</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="n">MEMCOMP_PHASE</span><span class="p">,</span> <span class="n">TEST_FAIL_STATUS</span><span class="p">,</span> <span class="n">comments</span><span class="o">=</span><span class="n">comment</span><span class="p">)</span>
                        <span class="n">append_testlog</span><span class="p">(</span><span class="n">comment</span><span class="p">)</span>

                    <span class="c1"># compare throughput to baseline</span>
                    <span class="n">current</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_throughput</span><span class="p">(</span><span class="n">cpllog</span><span class="p">)</span>
                    <span class="n">baseline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_throughput</span><span class="p">(</span><span class="n">baselog</span><span class="p">)</span>
                    <span class="c1">#comparing ypd so bigger is better</span>
                    <span class="k">if</span> <span class="n">baseline</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">current</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">diff</span> <span class="o">=</span> <span class="p">(</span><span class="n">baseline</span> <span class="o">-</span> <span class="n">current</span><span class="p">)</span><span class="o">/</span><span class="n">baseline</span>
                        <span class="n">tolerance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;TEST_TPUT_TOLERANCE&quot;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">tolerance</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">tolerance</span> <span class="o">=</span> <span class="mf">0.25</span>
                        <span class="n">expect</span><span class="p">(</span><span class="n">tolerance</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s2">&quot;Bad value for throughput tolerance in test&quot;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">diff</span> <span class="o">&lt;</span> <span class="n">tolerance</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_test_status</span><span class="o">.</span><span class="n">get_status</span><span class="p">(</span><span class="n">THROUGHPUT_PHASE</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_test_status</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="n">THROUGHPUT_PHASE</span><span class="p">,</span> <span class="n">TEST_PASS_STATUS</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_test_status</span><span class="o">.</span><span class="n">get_status</span><span class="p">(</span><span class="n">THROUGHPUT_PHASE</span><span class="p">)</span> <span class="o">!=</span> <span class="n">TEST_FAIL_STATUS</span><span class="p">:</span>
                            <span class="n">comment</span> <span class="o">=</span> <span class="s2">&quot;Error: Computation time increase &gt; </span><span class="si">{:d}</span><span class="s2"> pct from baseline&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">tolerance</span><span class="o">*</span><span class="mi">100</span><span class="p">))</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_test_status</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="n">THROUGHPUT_PHASE</span><span class="p">,</span> <span class="n">TEST_FAIL_STATUS</span><span class="p">,</span> <span class="n">comments</span><span class="o">=</span><span class="n">comment</span><span class="p">)</span>
                            <span class="n">append_testlog</span><span class="p">(</span><span class="n">comment</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_generate_baseline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        generate a new baseline case based on the current test</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_test_status</span><span class="p">:</span>
            <span class="c1"># generate baseline</span>
            <span class="n">success</span><span class="p">,</span> <span class="n">comments</span> <span class="o">=</span> <span class="n">generate_baseline</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="p">)</span>
            <span class="n">append_testlog</span><span class="p">(</span><span class="n">comments</span><span class="p">)</span>
            <span class="n">status</span> <span class="o">=</span> <span class="n">TEST_PASS_STATUS</span> <span class="k">if</span> <span class="n">success</span> <span class="k">else</span> <span class="n">TEST_FAIL_STATUS</span>
            <span class="n">baseline_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;BASEGEN_CASE&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_test_status</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">GENERATE_PHASE</span><span class="p">),</span> <span class="n">status</span><span class="p">,</span> <span class="n">comments</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">baseline_name</span><span class="p">))</span>
            <span class="n">basegen_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;BASELINE_ROOT&quot;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;BASEGEN_CASE&quot;</span><span class="p">))</span>
            <span class="c1"># copy latest cpl log to baseline</span>
            <span class="c1"># drop the date so that the name is generic</span>
            <span class="n">newestcpllogfiles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_latest_cpl_logs</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">cpllog</span> <span class="ow">in</span> <span class="n">newestcpllogfiles</span><span class="p">:</span>
                <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;/(cpl.*.log).*.gz&quot;</span><span class="p">,</span><span class="n">cpllog</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">m</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">baselog</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">basegen_dir</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">+</span><span class="s2">&quot;.gz&quot;</span>
                    <span class="n">safe_copy</span><span class="p">(</span><span class="n">cpllog</span><span class="p">,</span>
                              <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">basegen_dir</span><span class="p">,</span><span class="n">baselog</span><span class="p">))</span></div>


<div class="viewcode-block" id="FakeTest">
<a class="viewcode-back" href="../../../CIME_api/CIME.SystemTests.html#CIME.SystemTests.system_tests_common.FakeTest">[docs]</a>
<span class="k">class</span> <span class="nc">FakeTest</span><span class="p">(</span><span class="n">SystemTestsCommon</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Inheriters of the FakeTest Class are intended to test the code.</span>

<span class="sd">    All members of the FakeTest Class must</span>
<span class="sd">    have names beginnig with &quot;TEST&quot; this is so that the find_system_test</span>
<span class="sd">    in utils.py will work with these classes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">_set_script</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">script</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_script</span> <span class="o">=</span> <span class="n">script</span> <span class="c1"># pylint: disable=attribute-defined-outside-init</span>

<div class="viewcode-block" id="FakeTest.build_phase">
<a class="viewcode-back" href="../../../CIME_api/CIME.SystemTests.html#CIME.SystemTests.system_tests_common.FakeTest.build_phase">[docs]</a>
    <span class="k">def</span> <span class="nf">build_phase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sharedlib_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">model_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">sharedlib_only</span><span class="p">):</span>
            <span class="n">exeroot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;EXEROOT&quot;</span><span class="p">)</span>
            <span class="n">cime_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;MODEL&quot;</span><span class="p">)</span>
            <span class="n">modelexe</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">exeroot</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.exe&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cime_model</span><span class="p">))</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">modelexe</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#!/bin/bash</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_script</span><span class="p">)</span>

            <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">modelexe</span><span class="p">,</span> <span class="mo">0o755</span><span class="p">)</span>

            <span class="n">build</span><span class="o">.</span><span class="n">post_build</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="p">,</span> <span class="p">[],</span> <span class="n">build_complete</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="FakeTest.run_indv">
<a class="viewcode-back" href="../../../CIME_api/CIME.SystemTests.html#CIME.SystemTests.system_tests_common.FakeTest.run_indv">[docs]</a>
    <span class="k">def</span> <span class="nf">run_indv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;base&#39;</span><span class="p">,</span> <span class="n">st_archive</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">mpilib</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;MPILIB&quot;</span><span class="p">)</span>
        <span class="c1"># This flag is needed by mpt to run a script under mpiexec</span>
        <span class="k">if</span> <span class="n">mpilib</span> <span class="o">==</span> <span class="s2">&quot;mpt&quot;</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;MPI_SHEPHERD&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;true&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">FakeTest</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">run_indv</span><span class="p">(</span><span class="n">suffix</span><span class="p">,</span> <span class="n">st_archive</span><span class="p">)</span></div>
</div>


<div class="viewcode-block" id="TESTRUNPASS">
<a class="viewcode-back" href="../../../CIME_api/CIME.SystemTests.html#CIME.SystemTests.system_tests_common.TESTRUNPASS">[docs]</a>
<span class="k">class</span> <span class="nc">TESTRUNPASS</span><span class="p">(</span><span class="n">FakeTest</span><span class="p">):</span>

<div class="viewcode-block" id="TESTRUNPASS.build_phase">
<a class="viewcode-back" href="../../../CIME_api/CIME.SystemTests.html#CIME.SystemTests.system_tests_common.TESTRUNPASS.build_phase">[docs]</a>
    <span class="k">def</span> <span class="nf">build_phase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sharedlib_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">model_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">rundir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;RUNDIR&quot;</span><span class="p">)</span>
        <span class="n">cimeroot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;CIMEROOT&quot;</span><span class="p">)</span>
        <span class="n">case</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;CASE&quot;</span><span class="p">)</span>
        <span class="n">script</span> <span class="o">=</span> \
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">echo Insta pass</span>
<span class="sd">echo SUCCESSFUL TERMINATION &gt; {rundir}/{log}.log.$LID</span>
<span class="sd">cp {root}/scripts/tests/cpl.hi1.nc.test {rundir}/{case}.cpl.hi.0.nc</span>
<span class="sd">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rundir</span><span class="o">=</span><span class="n">rundir</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_cpllog</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="n">cimeroot</span><span class="p">,</span> <span class="n">case</span><span class="o">=</span><span class="n">case</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_script</span><span class="p">(</span><span class="n">script</span><span class="p">)</span>
        <span class="n">FakeTest</span><span class="o">.</span><span class="n">build_phase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                             <span class="n">sharedlib_only</span><span class="o">=</span><span class="n">sharedlib_only</span><span class="p">,</span> <span class="n">model_only</span><span class="o">=</span><span class="n">model_only</span><span class="p">)</span></div>
</div>


<div class="viewcode-block" id="TESTRUNDIFF">
<a class="viewcode-back" href="../../../CIME_api/CIME.SystemTests.html#CIME.SystemTests.system_tests_common.TESTRUNDIFF">[docs]</a>
<span class="k">class</span> <span class="nc">TESTRUNDIFF</span><span class="p">(</span><span class="n">FakeTest</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    You can generate a diff with this test as follows:</span>
<span class="sd">    1) Run the test and generate a baseline</span>
<span class="sd">    2) set TESTRUNDIFF_ALTERNATE environment variable to TRUE</span>
<span class="sd">    3) Re-run the same test from step 1 but do a baseline comparison instead of generation</span>
<span class="sd">      3.a) This should give you a DIFF</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="TESTRUNDIFF.build_phase">
<a class="viewcode-back" href="../../../CIME_api/CIME.SystemTests.html#CIME.SystemTests.system_tests_common.TESTRUNDIFF.build_phase">[docs]</a>
    <span class="k">def</span> <span class="nf">build_phase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sharedlib_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">model_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">rundir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;RUNDIR&quot;</span><span class="p">)</span>
        <span class="n">cimeroot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;CIMEROOT&quot;</span><span class="p">)</span>
        <span class="n">case</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;CASE&quot;</span><span class="p">)</span>
        <span class="n">script</span> <span class="o">=</span> \
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">echo Insta pass</span>
<span class="sd">echo SUCCESSFUL TERMINATION &gt; {rundir}/{log}.log.$LID</span>
<span class="sd">if [ -z &quot;$TESTRUNDIFF_ALTERNATE&quot; ]; then</span>
<span class="sd">  cp {root}/scripts/tests/cpl.hi1.nc.test {rundir}/{case}.cpl.hi.0.nc</span>
<span class="sd">else</span>
<span class="sd">  cp {root}/scripts/tests/cpl.hi2.nc.test {rundir}/{case}.cpl.hi.0.nc</span>
<span class="sd">fi</span>
<span class="sd">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rundir</span><span class="o">=</span><span class="n">rundir</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_cpllog</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="n">cimeroot</span><span class="p">,</span> <span class="n">case</span><span class="o">=</span><span class="n">case</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_script</span><span class="p">(</span><span class="n">script</span><span class="p">)</span>
        <span class="n">FakeTest</span><span class="o">.</span><span class="n">build_phase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                       <span class="n">sharedlib_only</span><span class="o">=</span><span class="n">sharedlib_only</span><span class="p">,</span> <span class="n">model_only</span><span class="o">=</span><span class="n">model_only</span><span class="p">)</span></div>
</div>


<div class="viewcode-block" id="TESTTESTDIFF">
<a class="viewcode-back" href="../../../CIME_api/CIME.SystemTests.html#CIME.SystemTests.system_tests_common.TESTTESTDIFF">[docs]</a>
<span class="k">class</span> <span class="nc">TESTTESTDIFF</span><span class="p">(</span><span class="n">FakeTest</span><span class="p">):</span>

<div class="viewcode-block" id="TESTTESTDIFF.build_phase">
<a class="viewcode-back" href="../../../CIME_api/CIME.SystemTests.html#CIME.SystemTests.system_tests_common.TESTTESTDIFF.build_phase">[docs]</a>
    <span class="k">def</span> <span class="nf">build_phase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sharedlib_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">model_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">rundir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;RUNDIR&quot;</span><span class="p">)</span>
        <span class="n">cimeroot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;CIMEROOT&quot;</span><span class="p">)</span>
        <span class="n">case</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;CASE&quot;</span><span class="p">)</span>
        <span class="n">script</span> <span class="o">=</span> \
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">echo Insta pass</span>
<span class="sd">echo SUCCESSFUL TERMINATION &gt; {rundir}/{log}.log.$LID</span>
<span class="sd">cp {root}/scripts/tests/cpl.hi1.nc.test {rundir}/{case}.cpl.hi.0.nc</span>
<span class="sd">cp {root}/scripts/tests/cpl.hi2.nc.test {rundir}/{case}.cpl.hi.0.nc.rest</span>
<span class="sd">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rundir</span><span class="o">=</span><span class="n">rundir</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_cpllog</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="n">cimeroot</span><span class="p">,</span> <span class="n">case</span><span class="o">=</span><span class="n">case</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_script</span><span class="p">(</span><span class="n">script</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TESTTESTDIFF</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">build_phase</span><span class="p">(</span><span class="n">sharedlib_only</span><span class="o">=</span><span class="n">sharedlib_only</span><span class="p">,</span>
                                              <span class="n">model_only</span><span class="o">=</span><span class="n">model_only</span><span class="p">)</span></div>


<div class="viewcode-block" id="TESTTESTDIFF.run_phase">
<a class="viewcode-back" href="../../../CIME_api/CIME.SystemTests.html#CIME.SystemTests.system_tests_common.TESTTESTDIFF.run_phase">[docs]</a>
    <span class="k">def</span> <span class="nf">run_phase</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TESTTESTDIFF</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">run_phase</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_component_compare_test</span><span class="p">(</span><span class="s2">&quot;base&quot;</span><span class="p">,</span> <span class="s2">&quot;rest&quot;</span><span class="p">)</span></div>
</div>


<div class="viewcode-block" id="TESTRUNFAIL">
<a class="viewcode-back" href="../../../CIME_api/CIME.SystemTests.html#CIME.SystemTests.system_tests_common.TESTRUNFAIL">[docs]</a>
<span class="k">class</span> <span class="nc">TESTRUNFAIL</span><span class="p">(</span><span class="n">FakeTest</span><span class="p">):</span>

<div class="viewcode-block" id="TESTRUNFAIL.build_phase">
<a class="viewcode-back" href="../../../CIME_api/CIME.SystemTests.html#CIME.SystemTests.system_tests_common.TESTRUNFAIL.build_phase">[docs]</a>
    <span class="k">def</span> <span class="nf">build_phase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sharedlib_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">model_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">rundir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;RUNDIR&quot;</span><span class="p">)</span>
        <span class="n">cimeroot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;CIMEROOT&quot;</span><span class="p">)</span>
        <span class="n">case</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;CASE&quot;</span><span class="p">)</span>
        <span class="n">script</span> <span class="o">=</span> \
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">if [ -z &quot;$TESTRUNFAIL_PASS&quot; ]; then</span>
<span class="sd">  echo Insta fail</span>
<span class="sd">  echo model failed &gt; {rundir}/{log}.log.$LID</span>
<span class="sd">  exit -1</span>
<span class="sd">else</span>
<span class="sd">  echo Insta pass</span>
<span class="sd">  echo SUCCESSFUL TERMINATION &gt; {rundir}/{log}.log.$LID</span>
<span class="sd">  cp {root}/scripts/tests/cpl.hi1.nc.test {rundir}/{case}.cpl.hi.0.nc</span>
<span class="sd">fi</span>
<span class="sd">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rundir</span><span class="o">=</span><span class="n">rundir</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_cpllog</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="n">cimeroot</span><span class="p">,</span> <span class="n">case</span><span class="o">=</span><span class="n">case</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_script</span><span class="p">(</span><span class="n">script</span><span class="p">)</span>
        <span class="n">FakeTest</span><span class="o">.</span><span class="n">build_phase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                             <span class="n">sharedlib_only</span><span class="o">=</span><span class="n">sharedlib_only</span><span class="p">,</span> <span class="n">model_only</span><span class="o">=</span><span class="n">model_only</span><span class="p">)</span></div>
</div>


<div class="viewcode-block" id="TESTRUNFAILEXC">
<a class="viewcode-back" href="../../../CIME_api/CIME.SystemTests.html#CIME.SystemTests.system_tests_common.TESTRUNFAILEXC">[docs]</a>
<span class="k">class</span> <span class="nc">TESTRUNFAILEXC</span><span class="p">(</span><span class="n">TESTRUNPASS</span><span class="p">):</span>

<div class="viewcode-block" id="TESTRUNFAILEXC.run_phase">
<a class="viewcode-back" href="../../../CIME_api/CIME.SystemTests.html#CIME.SystemTests.system_tests_common.TESTRUNFAILEXC.run_phase">[docs]</a>
    <span class="k">def</span> <span class="nf">run_phase</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Exception from run_phase&quot;</span><span class="p">)</span></div>
</div>


<div class="viewcode-block" id="TESTBUILDFAIL">
<a class="viewcode-back" href="../../../CIME_api/CIME.SystemTests.html#CIME.SystemTests.system_tests_common.TESTBUILDFAIL">[docs]</a>
<span class="k">class</span> <span class="nc">TESTBUILDFAIL</span><span class="p">(</span><span class="n">TESTRUNPASS</span><span class="p">):</span>

<div class="viewcode-block" id="TESTBUILDFAIL.build_phase">
<a class="viewcode-back" href="../../../CIME_api/CIME.SystemTests.html#CIME.SystemTests.system_tests_common.TESTBUILDFAIL.build_phase">[docs]</a>
    <span class="k">def</span> <span class="nf">build_phase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sharedlib_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">model_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;TESTBUILDFAIL_PASS&quot;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
            <span class="n">TESTRUNPASS</span><span class="o">.</span><span class="n">build_phase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sharedlib_only</span><span class="p">,</span> <span class="n">model_only</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">sharedlib_only</span><span class="p">):</span>
                <span class="n">expect</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;BUILD FAIL: Intentional fail for testing infrastructure&quot;</span><span class="p">)</span></div>
</div>


<div class="viewcode-block" id="TESTBUILDFAILEXC">
<a class="viewcode-back" href="../../../CIME_api/CIME.SystemTests.html#CIME.SystemTests.system_tests_common.TESTBUILDFAILEXC">[docs]</a>
<span class="k">class</span> <span class="nc">TESTBUILDFAILEXC</span><span class="p">(</span><span class="n">FakeTest</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">case</span><span class="p">):</span>
        <span class="n">FakeTest</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">case</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Exception from init&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="TESTRUNSLOWPASS">
<a class="viewcode-back" href="../../../CIME_api/CIME.SystemTests.html#CIME.SystemTests.system_tests_common.TESTRUNSLOWPASS">[docs]</a>
<span class="k">class</span> <span class="nc">TESTRUNSLOWPASS</span><span class="p">(</span><span class="n">FakeTest</span><span class="p">):</span>

<div class="viewcode-block" id="TESTRUNSLOWPASS.build_phase">
<a class="viewcode-back" href="../../../CIME_api/CIME.SystemTests.html#CIME.SystemTests.system_tests_common.TESTRUNSLOWPASS.build_phase">[docs]</a>
    <span class="k">def</span> <span class="nf">build_phase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sharedlib_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">model_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">rundir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;RUNDIR&quot;</span><span class="p">)</span>
        <span class="n">cimeroot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;CIMEROOT&quot;</span><span class="p">)</span>
        <span class="n">case</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;CASE&quot;</span><span class="p">)</span>
        <span class="n">script</span> <span class="o">=</span> \
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">sleep 300</span>
<span class="sd">echo Slow pass</span>
<span class="sd">echo SUCCESSFUL TERMINATION &gt; {rundir}/{log}.log.$LID</span>
<span class="sd">cp {root}/scripts/tests/cpl.hi1.nc.test {rundir}/{case}.cpl.hi.0.nc</span>
<span class="sd">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rundir</span><span class="o">=</span><span class="n">rundir</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_cpllog</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="n">cimeroot</span><span class="p">,</span> <span class="n">case</span><span class="o">=</span><span class="n">case</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_script</span><span class="p">(</span><span class="n">script</span><span class="p">)</span>
        <span class="n">FakeTest</span><span class="o">.</span><span class="n">build_phase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                        <span class="n">sharedlib_only</span><span class="o">=</span><span class="n">sharedlib_only</span><span class="p">,</span> <span class="n">model_only</span><span class="o">=</span><span class="n">model_only</span><span class="p">)</span></div>
</div>


<div class="viewcode-block" id="TESTMEMLEAKFAIL">
<a class="viewcode-back" href="../../../CIME_api/CIME.SystemTests.html#CIME.SystemTests.system_tests_common.TESTMEMLEAKFAIL">[docs]</a>
<span class="k">class</span> <span class="nc">TESTMEMLEAKFAIL</span><span class="p">(</span><span class="n">FakeTest</span><span class="p">):</span>
<div class="viewcode-block" id="TESTMEMLEAKFAIL.build_phase">
<a class="viewcode-back" href="../../../CIME_api/CIME.SystemTests.html#CIME.SystemTests.system_tests_common.TESTMEMLEAKFAIL.build_phase">[docs]</a>
    <span class="k">def</span> <span class="nf">build_phase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sharedlib_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">model_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">rundir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;RUNDIR&quot;</span><span class="p">)</span>
        <span class="n">cimeroot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;CIMEROOT&quot;</span><span class="p">)</span>
        <span class="n">case</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;CASE&quot;</span><span class="p">)</span>
        <span class="n">testfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cimeroot</span><span class="p">,</span><span class="s2">&quot;scripts&quot;</span><span class="p">,</span><span class="s2">&quot;tests&quot;</span><span class="p">,</span><span class="s2">&quot;cpl.log.failmemleak.gz&quot;</span><span class="p">)</span>
        <span class="n">script</span> <span class="o">=</span> \
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">echo Insta pass</span>
<span class="sd">gunzip -c {testfile} &gt; {rundir}/{log}.log.$LID</span>
<span class="sd">cp {root}/scripts/tests/cpl.hi1.nc.test {rundir}/{case}.cpl.hi.0.nc</span>
<span class="sd">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">testfile</span><span class="o">=</span><span class="n">testfile</span><span class="p">,</span> <span class="n">rundir</span><span class="o">=</span><span class="n">rundir</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_cpllog</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="n">cimeroot</span><span class="p">,</span> <span class="n">case</span><span class="o">=</span><span class="n">case</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_script</span><span class="p">(</span><span class="n">script</span><span class="p">)</span>
        <span class="n">FakeTest</span><span class="o">.</span><span class="n">build_phase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                        <span class="n">sharedlib_only</span><span class="o">=</span><span class="n">sharedlib_only</span><span class="p">,</span> <span class="n">model_only</span><span class="o">=</span><span class="n">model_only</span><span class="p">)</span></div>
</div>


<div class="viewcode-block" id="TESTMEMLEAKPASS">
<a class="viewcode-back" href="../../../CIME_api/CIME.SystemTests.html#CIME.SystemTests.system_tests_common.TESTMEMLEAKPASS">[docs]</a>
<span class="k">class</span> <span class="nc">TESTMEMLEAKPASS</span><span class="p">(</span><span class="n">FakeTest</span><span class="p">):</span>
<div class="viewcode-block" id="TESTMEMLEAKPASS.build_phase">
<a class="viewcode-back" href="../../../CIME_api/CIME.SystemTests.html#CIME.SystemTests.system_tests_common.TESTMEMLEAKPASS.build_phase">[docs]</a>
    <span class="k">def</span> <span class="nf">build_phase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sharedlib_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">model_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">rundir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;RUNDIR&quot;</span><span class="p">)</span>
        <span class="n">cimeroot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;CIMEROOT&quot;</span><span class="p">)</span>
        <span class="n">case</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;CASE&quot;</span><span class="p">)</span>
        <span class="n">testfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cimeroot</span><span class="p">,</span><span class="s2">&quot;scripts&quot;</span><span class="p">,</span><span class="s2">&quot;tests&quot;</span><span class="p">,</span><span class="s2">&quot;cpl.log.passmemleak.gz&quot;</span><span class="p">)</span>
        <span class="n">script</span> <span class="o">=</span> \
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">echo Insta pass</span>
<span class="sd">gunzip -c {testfile} &gt; {rundir}/{log}.log.$LID</span>
<span class="sd">cp {root}/scripts/tests/cpl.hi1.nc.test {rundir}/{case}.cpl.hi.0.nc</span>
<span class="sd">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">testfile</span><span class="o">=</span><span class="n">testfile</span><span class="p">,</span> <span class="n">rundir</span><span class="o">=</span><span class="n">rundir</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_cpllog</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="n">cimeroot</span><span class="p">,</span> <span class="n">case</span><span class="o">=</span><span class="n">case</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_script</span><span class="p">(</span><span class="n">script</span><span class="p">)</span>
        <span class="n">FakeTest</span><span class="o">.</span><span class="n">build_phase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                        <span class="n">sharedlib_only</span><span class="o">=</span><span class="n">sharedlib_only</span><span class="p">,</span> <span class="n">model_only</span><span class="o">=</span><span class="n">model_only</span><span class="p">)</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2017, U.S. National Science Foundation and U.S. Department of Energy.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
  
     
<script>var version_json_loc = "../../../../../versions.json";</script>


</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>